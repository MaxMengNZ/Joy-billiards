# 🎓 学生赛与成人赛分离系统 - 实施文档

**实施日期：** 2025-11-07  
**状态：** ✅ 已完成（本地测试）  
**架构方案：** 方案A - 分离排行榜

---

## 📋 目录

1. [系统概述](#系统概述)
2. [数据库设计](#数据库设计)
3. [前端实现](#前端实现)
4. [管理员操作](#管理员操作)
5. [积分规则建议](#积分规则建议)
6. [常见问题](#常见问题)

---

## 一、系统概述

### 🎯 设计目标

- ✅ 学生赛和成人赛**分离排行榜**
- ✅ 学生有独立的荣誉体系和成就感
- ✅ 避免不同年龄组/水平的不公平竞争
- ✅ 符合国际台球赛事惯例
- ✅ **保持数据库干净整洁**（无新表，仅扩展现有表）

### 📊 核心区别

| 对比项 | 成人赛 👔 | 学生赛 🎓 |
|--------|---------|----------|
| **参与者** | 成人玩家 | 学生玩家 |
| **强度** | 标准强度 | 适合初学者 |
| **排行榜** | 成人排行榜 | 学生排行榜 |
| **积分建议** | 冠军 +20, 亚军 +15 | 冠军 +15, 亚军 +10 |
| **段位系统** | 共享同一套段位 | 共享同一套段位 |

---

## 二、数据库设计

> 🆕 **2025-11-12 更新**  
> - 已弃用 `player_category` 字段方案，改为**双维度战绩 + 双排行榜**。  
> - `users` 表新增以下字段，并通过触发器自动同步总战绩：  
>   - `pro_wins`, `pro_losses`, `pro_break_and_run_count`  
>   - `student_wins`, `student_losses`, `student_break_and_run_count`  
> - 现有 `wins / losses / break_and_run_count` 自动等于 Pro+Student。  
> - 新增 `admin_update_division_stats` 安全函数，支持按组别增量/绝对更新战绩并写入审计日志。  
> - 更新 `public_users` 视图与 `admin_get_all_users()`，包含双组别战绩与积分。  
> - 新建触发器 `sync_user_division_totals`，确保任何写入都保持三个维度同步。  
> - 前端（Players / Leaderboard / Admin / Profile）均已适配双组别战绩展示。  
> - 请忽略下文旧的 `player_category` 设计，保留作为历史记录。

### ✅ 无新表创建，仅扩展现有表

#### 1. `users` 表扩展

**新增字段：**
```sql
player_category VARCHAR(20) DEFAULT 'adult' 
CHECK (player_category IN ('adult', 'student'))
```

**说明：**
- `adult` - 成人玩家（默认值）
- `student` - 学生玩家
- 所有现有用户默认为 `adult`

---

#### 2. `tournaments` 表扩展

**新增字段：**
```sql
participant_category VARCHAR(20) DEFAULT 'adult' 
CHECK (participant_category IN ('adult', 'student', 'mixed'))
```

**说明：**
- `adult` - 成人赛
- `student` - 学生赛
- `mixed` - 混合赛（可选，未来可能使用）

**自动识别：**
- 比赛名称包含"学生"或"Student" → 自动标记为 `student`
- 其他比赛 → 默认为 `adult`

---

#### 3. 创建的视图（View）

**成人排行榜视图：**
```sql
CREATE VIEW adult_leaderboard AS
SELECT id, name, ranking_points, ranking_level, wins, losses, ...
FROM users
WHERE player_category = 'adult' AND is_active = true AND ranking_points > 0
ORDER BY ranking_points DESC;
```

**学生排行榜视图：**
```sql
CREATE VIEW student_leaderboard AS
SELECT id, name, ranking_points, ranking_level, wins, losses, ...
FROM users
WHERE player_category = 'student' AND is_active = true AND ranking_points > 0
ORDER BY ranking_points DESC;
```

**综合排行榜视图：**
```sql
CREATE VIEW combined_leaderboard AS
SELECT *, 
  CASE 
    WHEN player_category = 'student' THEN '🎓'
    WHEN player_category = 'adult' THEN '👔'
  END as category_icon
FROM users
WHERE is_active = true AND ranking_points > 0
ORDER BY ranking_points DESC;
```

**更新 public_users 视图：**
```sql
-- 添加 player_category 字段到公开视图
ALTER VIEW public_users ADD COLUMN player_category;
```

---

## 三、前端实现

### 1. 排行榜页面（LeaderboardPage.vue）

**新增功能：**

**类别切换标签：**
```
┌──────────────────────────────┐
│ [👔 Adult] [🎓 Student] [🌐 All] │
└──────────────────────────────┘
```

**筛选逻辑：**
- **Adult**：只显示 `player_category = 'adult'` 的玩家
- **Student**：只显示 `player_category = 'student'` 的玩家
- **All**：显示所有玩家（带类别图标 👔/🎓）

**代码实现：**
```javascript
const categoryFilter = ref('adult') // 默认显示成人榜

const rankedPlayers = computed(() => {
  let filtered = players.value.filter(p => displayPoints > 0)
  
  if (categoryFilter.value === 'adult') {
    filtered = filtered.filter(p => p.player_category === 'adult' || !p.player_category)
  } else if (categoryFilter.value === 'student') {
    filtered = filtered.filter(p => p.player_category === 'student')
  }
  // 'all' 时不过滤
  
  return filtered.sort((a, b) => b.points - a.points)
})
```

---

### 2. 管理员页面（AdminDashboard.vue）

**新增功能：**

**Category 列：**
- 显示玩家类别徽章（👔 Adult / 🎓 Student）

**Actions 新增按钮：**
- **切换类别按钮**：`👔→🎓` 或 `🎓→👔`
- 点击即可切换玩家类别
- 带确认提示

**表格结构：**
```
| Name | Contact | Membership | Category | Rank | ... | Actions |
|------|---------|------------|----------|------|-----|---------|
| 张三 | ...     | Plus       | 👔 Adult | 🔸   | ... | [📝][💳][💰][👔→🎓]... |
```

**代码实现：**
```javascript
const togglePlayerCategory = async (user) => {
  const newCategory = user.player_category === 'student' ? 'adult' : 'student'
  if (!confirm(`Change to ${newCategory}?`)) return
  
  await supabase.from('users')
    .update({ player_category: newCategory })
    .eq('id', user.id)
  
  alert('Category updated!')
}
```

---

### 3. 比赛页面（TournamentsPage.vue）

**新增功能：**

**比赛类别徽章：**
- 每个比赛卡片显示类别徽章
- 👔 Adult（蓝色渐变）
- 🎓 Student（绿色渐变）

**显示位置：**
```
┌────────────────────────────────┐
│ Tournament Name [🎓 Student]   │
│ [Registration]                 │
│ ...                            │
└────────────────────────────────┘
```

---

## 四、管理员操作指南

### 1. 设置玩家为学生

**步骤：**
1. 登录管理员页面：http://localhost:3000/admin
2. 找到目标玩家
3. 点击 Actions 列的 `👔→🎓` 按钮
4. 确认切换
5. 该玩家将显示为 `🎓 Student`

**批量设置（SQL）：**
```sql
-- 批量设置学生（根据年龄）
UPDATE users 
SET player_category = 'student' 
WHERE birthday > '2007-01-01';  -- 例如：18岁以下

-- 批量设置学生（根据名单）
UPDATE users 
SET player_category = 'student' 
WHERE name IN ('张三', '李四', '王五');
```

---

### 2. 创建学生赛事

**步骤：**
1. 创建比赛时，名称包含"学生"或"Student"
2. 系统自动识别为学生赛
3. 比赛页面自动显示 🎓 Student 徽章

**或手动设置：**
```sql
UPDATE tournaments 
SET participant_category = 'student' 
WHERE id = '<tournament_id>';
```

---

### 3. 查看分离后的排行榜

**成人榜：**
- 访问排行榜页面
- 默认显示"👔 Adult"标签
- 只显示成人玩家

**学生榜：**
- 点击"🎓 Student"标签
- 只显示学生玩家

**全部：**
- 点击"🌐 All"标签
- 显示所有玩家（带类别图标）

---

## 五、积分规则建议

### 📊 推荐积分分配

#### 成人赛（Adult Tournament）

| 名次 | 积分 | 说明 |
|------|------|------|
| 🏆 冠军 | +20 | 标准积分 |
| 🥈 亚军 | +15 | |
| 🎯 四强 | +10 | |
| ⚔️ 八强 | +6 | |
| ✅ 参与 | +3 | 鼓励参与 |

#### 学生赛（Student Tournament）

| 名次 | 积分 | 说明 |
|------|------|------|
| 🏆 冠军 | +15 | 比成人赛少 25% |
| 🥈 亚军 | +10 | |
| 🎯 四强 | +6 | |
| ⚔️ 八强 | +4 | |
| ✅ 参与 | +2 | 鼓励参与 |

### 🎯 积分差异原因

1. **强度差异** - 学生赛难度较低，适合初学者
2. **公平性** - 避免学生通过低强度赛事快速刷分
3. **成长路径** - 学生"毕业"到成人赛时有明确的进步空间

---

## 六、段位系统（共享）

### 段位表（Adult & Student 共享）

| 段位 | 英文 | 徽章 | 积分范围 |
|------|------|------|---------|
| 初学 | Beginner | ⚪ | 0–14 |
| 进阶 | Intermediate | 🔸 | 15–39 |
| 高阶 | Advance | 🔺 | 40–79 |
| 黄金 | Expert | 🔶 | 80–149 |
| 精英 | Elite | 🔷 | 150–249 |
| 大师 | Master | ⭐ | 250–349 |
| 特级大师 | Grand Master | 🌟 | 350–449 |
| 职业段 | Pro Level | 💎 | 450–549 |
| 殿堂 | Hall of Fame | 👑 | 550+ |

**说明：**
- ✅ 成人和学生使用**同一套段位系统**
- ✅ 段位晋升规则相同
- ✅ 但在各自的排行榜中独立排名

---

## 七、学生"毕业"规则（建议）

### 🎓→👔 转换规则

**自动转换条件（建议）：**
1. **年龄达标**：年满 18 岁
2. **时间节点**：每年 1 月 1 日批量转换
3. **通知提醒**：生日月提前通知

**手动转换：**
- 管理员可以随时手动切换玩家类别
- 用于特殊情况（例如：提前"毕业"的优秀学生）

**转换后：**
- ✅ 保留所有积分和段位
- ✅ 转入成人排行榜
- ✅ 参加成人赛获得成人赛积分
- ✅ 历史数据保留

---

## 八、常见问题

### Q1: 学生可以参加成人赛吗？
**A:** 建议规则：
- ✅ 学生可以参加成人赛（挑战自我）
- ✅ 在成人赛中获得成人赛积分
- ✅ 排名仍在学生榜（除非手动转换）

### Q2: 学生赛积分为什么比成人赛少？
**A:** 
- 学生赛难度较低，适合初学者
- 防止通过低强度赛事快速刷分
- 保持积分系统的公平性

### Q3: 学生"毕业"后积分会清零吗？
**A:** 
- ❌ 不会清零
- ✅ 所有积分和段位保留
- ✅ 只是从学生榜转入成人榜

### Q4: 如何区分学生和成人？
**A:** 
- 建议：18岁以下为学生
- 管理员可以手动设置
- 也可以根据实际情况灵活调整

### Q5: 学生排行榜会很空吗？
**A:** 
- 初期可能较少
- 随着学生赛推广会逐渐增加
- 可以考虑将现有的年轻玩家转为学生类别

---

## 九、前端功能清单

### ✅ 已实现功能

#### 1. 排行榜页面
- ✅ 类别切换标签（👔 Adult / 🎓 Student / 🌐 All）
- ✅ 默认显示成人榜
- ✅ 学生榜独立显示
- ✅ "All" 显示所有玩家并标注类别

#### 2. 管理员页面
- ✅ 新增 "Category" 列
- ✅ 显示类别徽章（👔 Adult / 🎓 Student）
- ✅ Actions 新增切换类别按钮（👔→🎓）
- ✅ 一键切换玩家类别

#### 3. 比赛页面
- ✅ 每个比赛显示类别徽章
- ✅ 👔 Adult（蓝色渐变）
- ✅ 🎓 Student（绿色渐变）
- ✅ 自动根据比赛名称识别

#### 4. 数据库视图
- ✅ `adult_leaderboard` - 成人榜
- ✅ `student_leaderboard` - 学生榜
- ✅ `combined_leaderboard` - 综合榜（带图标）
- ✅ `public_users` - 更新包含 player_category

---

## 十、管理员快速操作

### 设置学生玩家

**方法1：通过管理员页面**
1. 访问 http://localhost:3000/admin
2. 找到目标玩家
3. 点击 `👔→🎓` 按钮
4. 确认

**方法2：通过 SQL（批量）**
```sql
-- 根据年龄批量设置
UPDATE users 
SET player_category = 'student' 
WHERE EXTRACT(YEAR FROM AGE(birthday)) < 18;

-- 根据名单设置
UPDATE users 
SET player_category = 'student' 
WHERE name IN ('张三', '李四', '王五');

-- 单个设置
UPDATE users 
SET player_category = 'student' 
WHERE email = 'student@example.com';
```

---

### 创建学生赛事

**方法1：命名规则（自动识别）**
- 比赛名称包含"学生"或"Student"
- 系统自动标记为学生赛

**方法2：手动设置**
```sql
UPDATE tournaments 
SET participant_category = 'student' 
WHERE name LIKE '%学生%';
```

---

### 查看统计数据

```sql
-- 查看成人/学生分布
SELECT 
  player_category,
  COUNT(*) as total,
  SUM(CASE WHEN ranking_points > 0 THEN 1 ELSE 0 END) as ranked,
  AVG(ranking_points) as avg_points
FROM users
WHERE is_active = true
GROUP BY player_category;

-- 查看成人榜 Top 10
SELECT name, ranking_points, ranking_level 
FROM adult_leaderboard 
LIMIT 10;

-- 查看学生榜 Top 10
SELECT name, ranking_points, ranking_level 
FROM student_leaderboard 
LIMIT 10;
```

---

## 十一、未来扩展建议

### 🚀 Phase 2 功能（可选）

1. **年龄自动转换**
   - 每年 1 月 1 日自动检查年龄
   - 年满 18 岁自动转入成人组
   - 发送通知邮件

2. **学生专属奖励**
   - 学费减免
   - 免费训练课程
   - 装备赞助

3. **段位细分**
   - 学生段位可以有独立的徽章样式
   - 例如：学生大师 🎓⭐ vs 成人大师 👔⭐

4. **混合赛事**
   - `participant_category = 'mixed'`
   - 学生和成人同场竞技
   - 积分分别计入各自榜单

---

## 十二、数据库状态

### 当前状态

```
总用户数：129人
├─ 成人玩家：129人（全部，默认值）
└─ 学生玩家：0人（待管理员设置）

比赛数量：4个
├─ 成人赛：2个（Weekly, China Masters）
└─ 学生赛：2个（Student Challenge 1 & 2）
```

---

## 十三、重要提醒

### ⚠️ 注意事项

1. **现有用户默认为成人**
   - 所有现有用户的 `player_category = 'adult'`
   - 需要管理员手动设置学生玩家

2. **积分不变**
   - 切换类别不影响现有积分
   - 只影响排行榜显示位置

3. **段位系统共享**
   - 学生和成人使用同一套段位
   - 段位晋升规则相同

4. **比赛自动识别**
   - 名称含"学生/Student" → 学生赛
   - 其他 → 成人赛
   - 可手动调整

---

## 十四、测试步骤

### 🧪 功能测试清单

#### 1. 排行榜页面测试
- [ ] 访问 http://localhost:3000/leaderboard
- [ ] 看到类别切换标签（Adult/Student/All）
- [ ] 默认显示成人榜
- [ ] 点击 Student 标签 → 显示学生榜（目前为空）
- [ ] 点击 All 标签 → 显示所有玩家（全部为 👔）

#### 2. 管理员页面测试
- [ ] 访问 http://localhost:3000/admin
- [ ] 看到 Category 列
- [ ] 所有用户显示 👔 Adult
- [ ] 选择一个测试用户
- [ ] 点击 👔→🎓 按钮
- [ ] 确认切换
- [ ] 该用户显示为 🎓 Student

#### 3. 比赛页面测试
- [ ] 访问 http://localhost:3000/tournaments
- [ ] 学生赛显示 🎓 Student 徽章
- [ ] 成人赛显示 👔 Adult 徽章

#### 4. 切换类别后测试
- [ ] 将测试用户设置为 Student
- [ ] 给该用户添加积分
- [ ] 排行榜切换到 Student 标签
- [ ] 应该看到该用户在学生榜
- [ ] 切换回 Adult 标签
- [ ] 学生用户不显示

---

## 十五、技术细节

### 数据库表结构变更

**users 表：**
```
+ player_category VARCHAR(20) DEFAULT 'adult'
```

**tournaments 表：**
```
+ participant_category VARCHAR(20) DEFAULT 'adult'
```

**新增视图：**
- `adult_leaderboard`
- `student_leaderboard`
- `combined_leaderboard`

**更新视图：**
- `public_users` (添加 player_category 字段)

### 前端文件变更

1. `src/views/LeaderboardPage.vue`
   - 新增 `categoryFilter` ref
   - 新增类别切换标签 HTML
   - 修改 `rankedPlayers` computed（添加过滤逻辑）
   - 新增类别标签 CSS

2. `src/views/AdminDashboard.vue`
   - 新增 Category 列
   - 新增 `togglePlayerCategory()` 函数
   - 新增类别切换按钮
   - 新增类别徽章 CSS

3. `src/views/TournamentsPage.vue`
   - 修改比赛标题布局
   - 新增类别徽章显示
   - 新增类别徽章 CSS

---

## 十六、后续建议

### 📝 建议接下来做的事

1. **设置学生玩家**
   - 根据实际情况将年轻玩家设置为 Student
   - 建议标准：≤18岁 或 在校学生

2. **调整积分规则**
   - 明确学生赛和成人赛的积分差异
   - 更新 `HEYBALL_RANKING_RULES.md` 文档

3. **通知玩家**
   - 告知玩家现在有学生榜和成人榜
   - 解释分离的原因和好处

4. **监控数据**
   - 观察学生榜的参与度
   - 根据实际情况调整积分规则

---

## 十七、数据库完整性

### ✅ 保持干净整洁

**无新表创建：**
- ❌ 未创建 `student_users` 表
- ❌ 未创建 `adult_users` 表
- ❌ 未创建 `student_tournaments` 表
- ✅ 只扩展现有的 `users` 和 `tournaments` 表

**只使用视图（View）：**
- ✅ `adult_leaderboard` - 查询视图，不占存储
- ✅ `student_leaderboard` - 查询视图，不占存储
- ✅ `combined_leaderboard` - 查询视图，不占存储

**优势：**
- 📊 数据集中管理
- 🔄 易于维护
- 💾 不增加存储成本
- 🚀 查询性能高

---

## 十八、示例场景

### 场景1：新注册学生玩家

1. 学生注册账号
2. 管理员设置为 `player_category = 'student'`
3. 参加学生赛，获得积分
4. 出现在学生排行榜
5. 年满18岁后转入成人组

---

### 场景2：学生参加成人赛

1. 学生玩家（`category = 'student'`）
2. 报名参加成人赛（`participant_category = 'adult'`）
3. 获得成人赛积分（+20 for champion）
4. 积分计入学生排行榜（因为玩家类别是 student）
5. 在学生榜中排名上升

---

### 场景3：查看排行榜

**访问排行榜页面：**
```
┌────────────────────────────────┐
│ [👔 Adult] [🎓 Student] [🌐 All] │
├────────────────────────────────┤
│ 成人榜（默认）：                │
│ 1. Max Meng - 450分 👔          │
│ 2. Jason Wu - 380分 👔          │
│ 3. Yan Liu - 320分 👔           │
└────────────────────────────────┘

点击 "🎓 Student" →

┌────────────────────────────────┐
│ [👔 Adult] [🎓 Student] [🌐 All] │
├────────────────────────────────┤
│ 学生榜：                        │
│ 1. 张三 - 120分 🎓              │
│ 2. 李四 - 95分 🎓               │
│ 3. 王五 - 80分 🎓               │
└────────────────────────────────┘
```

---

*最后更新：2025-11-07*  
*状态：⚠️ 本地测试完成，待推送到生产环境*

---

**© 2025 Joy Billiards NZ. All Rights Reserved.**

