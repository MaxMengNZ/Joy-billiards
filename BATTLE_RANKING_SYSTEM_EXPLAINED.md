# 🎱 Battle Ranking System - 详细说明

## 📊 Elo 分数计算系统

### 1. Elo 计算公式

使用标准的 Elo 评分系统，K-factor = 32（默认值）

**公式：**
```
期望得分 = 1 / (1 + 10^((对手Elo - 我的Elo) / 400))
Elo变化 = K × (实际得分 - 期望得分)
```

**实际得分：**
- 胜利 = 1
- 失败 = 0

### 2. 输赢分数示例

#### 相同 Elo 对战（1000 vs 1000）
- **胜者获得**: +16 Elo
- **败者失去**: -16 Elo
- **结果**: 1000 → 1016 / 1000 → 984

#### 高 Elo 击败低 Elo（1200 vs 1000）
- **胜者获得**: +8 Elo（因为期望获胜）
- **败者失去**: -8 Elo
- **结果**: 1200 → 1208 / 1000 → 992

#### 低 Elo 击败高 Elo（1000 vs 1200）
- **胜者获得**: +24 Elo（因为意外获胜，奖励更多）
- **败者失去**: -24 Elo
- **结果**: 1000 → 1024 / 1200 → 1176

#### 巨大差距（1500 vs 1000）
- **高 Elo 胜**: +2 Elo（几乎不涨分）
- **低 Elo 胜**: +30 Elo（巨大奖励）
- **结果**: 1500 → 1502 / 1000 → 1030

### 3. Elo 变化范围

- **最小变化**: 约 1-2 Elo（巨大差距时）
- **最大变化**: 约 30-32 Elo（低分击败高分时）
- **平均变化**: 约 16 Elo（相同水平时）

---

## ⭐ 段位与星数系统

### 1. 段位结构

系统有 **28 个段位**，分为 10 个大组：

| 大组 | 段位名称 | Elo 范围 | 每段位Elo | 约需场次 | 保护机制 |
|------|---------|---------|----------|---------|---------|
| 1 | Bronze III/I/II | 1000-1300 | 100 | 6-7场 | ✅ 有保护 |
| 2 | Silver III/I/II | 1300-1600 | 100 | 6-7场 | ✅ 有保护 |
| 3 | Gold IV/III/II/I | 1600-2000 | 100 | 6-7场 | Gold IV有保护 |
| 4 | Platinum IV/III/II/I | 1900-2300 | 100 | 6-7场 | ❌ 无保护 |
| 5 | Diamond V/IV/III/II/I | 2200-2700 | 80-100 | 5-7场 | ❌ 无保护 |
| 6 | Master V/IV/III/II/I | 2600-3000 | 80 | 5-6场 | ❌ 无保护 |
| 7 | Grand Master | 3000-3200 | 200 | 12-13场 | ❌ 无保护 |
| 8 | The King | 3200-3400 | 200 | 12-13场 | ❌ 无保护 |
| 9 | Legend | 3400-3600 | 200 | 12-13场 | ❌ 无保护 |
| 10 | Hall of Fame | 3600+ | - | - | ❌ 无保护 |

### 2. 星数计算方式

**星数 = (当前Elo - 段位最低Elo) / 段位Elo范围 × 星数要求**

**示例：Bronze III（1000-1100，需要3星）**
- Elo 1000: 0星
- Elo 1033: 约1星
- Elo 1066: 约2星
- Elo 1100: 3星（满星，可升级到 Bronze II）

**更合理的升级速度**:
- 每个小段位（III, II, I）: 约 6-7 场比赛
- 每个大段位（Bronze, Silver等）: 约 18-21 场比赛
- 从 Bronze III 到 Silver I: 约 30-35 场比赛

### 3. 段位升级/降级规则

#### 自动升级
- 当 Elo 达到下一个段位的最低要求时，**自动升级**
- 例如：Elo 2450 → 自动升级到 Bronze II

#### 自动降级
- 当 Elo 低于当前段位的最低要求时，**自动降级**
- 例如：Elo 从 2550 降到 2449 → 自动降级到 Bronze III

#### 星数变化
- 星数根据 Elo 在段位内的位置**自动计算**
- 每次 Elo 变化后，星数自动更新

---

## 🎮 匹配赛 vs 挑战赛

### 匹配赛（Matchmaking）
**条件**: 对手段位差 ≤ 1 个大组

**规则**:
- ✅ 胜利: +1星（通过 Elo 增加实现）
- ❌ 失败: -1星（通过 Elo 减少实现）
- 🛡️ **保护机制**: Gold IV 及以下失败不降星

**示例**:
- Bronze III vs Bronze II → 匹配赛
- Gold I vs Platinum IV → 匹配赛

### 挑战赛（Challenge）
**条件**: 对手段位差 > 1 个大组

**规则**:
- 低段位击败高段位: +段位差星（通过 Elo 大幅增加实现）
- 高段位击败低段位: -段位差星（通过 Elo 大幅减少实现）

**示例**:
- Bronze III vs Gold I（差2个大组）
  - Bronze 胜: +2星（通过 Elo +32 实现）
  - Gold 败: -2星（通过 Elo -32 实现）

---

## 📈 升级示例（重新平衡后）

### 示例 1: 从 Bronze III 升级到 Bronze II

**初始状态**:
- Elo: 1000
- 段位: Bronze III
- 星数: 0/3

**需要**: Elo 达到 1100（Bronze II 的最低要求）

**升级路径**:
- 1000 → 1100: 需要约 6-7 场胜利（假设平均 +16 Elo/场）
- 1100: 自动升级到 Bronze II，星数重置为 0/3

### 示例 2: 从 Bronze III 到 Silver I

**初始状态**:
- Elo: 1000
- 段位: Bronze III

**升级路径**:
1. Bronze III → Bronze II: 1000 → 1100（约6-7场）
2. Bronze II → Bronze I: 1100 → 1200（约6-7场）
3. Bronze I → Silver III: 1200 → 1300（约6-7场）
4. Silver III → Silver II: 1300 → 1400（约6-7场）
5. Silver II → Silver I: 1400 → 1500（约6-7场）

**总计**: 从 Bronze III 到 Silver I 需要约 **30-35 场比赛**

### 示例 3: 从 Gold III 升级到 Gold II

**初始状态**:
- Elo: 1700
- 段位: Gold III
- 星数: 0/3

**需要**: Elo 达到 1800（Gold II 的最低要求）

**升级路径**:
- 1700 → 1800: 需要约 6-7 场胜利
- 1800: 自动升级到 Gold II，星数重置为 0/3

---

## 🛡️ 保护机制

### 低段位保护（Gold IV 及以下）

**受保护的段位**:
- Bronze III/I/II
- Silver III/I/II
- Gold IV

**保护规则**:
- 失败时**不降星**（但 Elo 仍然会下降）
- 防止新手玩家快速掉段

**示例**:
- Bronze III (Elo 1500) 失败
- Elo 降到 1484
- 星数可能从 1星 降到 0星，但不会降段

### 无保护段位（Gold III 及以上）

**无保护的段位**:
- Gold III/II/I
- Platinum 所有段位
- Diamond 所有段位
- Master 所有段位
- 所有 King 段位

**规则**:
- 失败时正常降星和降段
- 需要谨慎对战

---

## 🔄 自动更新机制

### 触发器系统

1. **Elo 更新触发器** (`trigger_update_battle_tier`)
   - 当 `battle_elo_rating` 改变时自动触发
   - 自动计算新段位
   - 自动计算新星数

2. **比赛完成触发器** (`update_elo_after_battle_room_complete`)
   - 比赛完成时自动更新 Elo
   - 自动更新胜场/负场
   - 自动更新连胜/连败
   - 调用排名更新函数

3. **排名更新函数** (`update_battle_positions`)
   - 根据 Elo 重新计算全球排名
   - 按 Elo 降序排列
   - 相同 Elo 时按胜场/负场排序

---

## 📊 数据流程

```
比赛完成
  ↓
更新 Elo（根据胜负和对手 Elo）
  ↓
触发器自动更新段位（根据新 Elo）
  ↓
触发器自动更新星数（根据新 Elo 和段位）
  ↓
更新胜场/负场/连胜
  ↓
更新全球排名
```

---

## 💡 关键要点

1. **Elo 是基础**: 所有段位和星数都基于 Elo 计算
2. **自动更新**: 段位和星数通过触发器自动更新，无需手动操作
3. **保护机制**: 低段位有保护，高段位需要谨慎
4. **匹配类型**: 根据段位差自动判断是匹配赛还是挑战赛
5. **公平性**: 击败高段位获得更多 Elo，击败低段位获得较少 Elo
