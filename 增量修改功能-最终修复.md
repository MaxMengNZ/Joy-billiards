# âœ… å¢é‡ä¿®æ”¹åŠŸèƒ½ - æœ€ç»ˆä¿®å¤å®Œæˆ

## ğŸ› é—®é¢˜å›é¡¾

### ç”¨æˆ·åé¦ˆ
> "ä½¿ç”¨ Increment Mode æ·»åŠ  Beilei Zhao çš„æ•°æ®ï¼Œæäº¤æ˜¾ç¤ºæˆåŠŸï¼Œä½†å®é™…è¿˜æ˜¯ 0"

---

## ğŸ” é—®é¢˜è¯Šæ–­è¿‡ç¨‹

### é—®é¢˜ 1ï¼šRLS ç­–ç•¥é”™è¯¯ âŒ
**ç—‡çŠ¶**ï¼šå‰ç«¯æäº¤æ˜¾ç¤º"æˆåŠŸ"ï¼Œä½†æ•°æ®åº“æ²¡æœ‰æ›´æ–°

**åŸå› **ï¼š
```sql
-- é”™è¯¯çš„ç­–ç•¥
EXISTS (
  SELECT 1 FROM users 
  WHERE id = auth.uid()  â† âŒ é”™è¯¯ï¼
  AND role = 'admin'
)
```

**è¯´æ˜**ï¼š
- `users.id` æ˜¯ public.users è¡¨çš„ä¸»é”®
- `auth.uid()` è¿”å›çš„æ˜¯ auth.users.id
- è¿™ä¸¤ä¸ª UUID ä¸ç›¸å…³ï¼
- åº”è¯¥ç”¨ `auth_id = auth.uid()`

**ä¿®å¤**ï¼š
```sql
-- æ­£ç¡®çš„ç­–ç•¥
EXISTS (
  SELECT 1 FROM users 
  WHERE auth_id = auth.uid()  â† âœ… æ­£ç¡®ï¼
  AND role = 'admin'
)
```

---

### é—®é¢˜ 2ï¼špublic_users è§†å›¾å®šä¹‰ä¸å®Œæ•´ âŒ

**ç—‡çŠ¶**ï¼šå³ä½¿ RLS ä¿®å¤åï¼Œå‰ç«¯ä»ç„¶æ˜¾ç¤ºæ—§æ•°æ®

**åŸå› **ï¼š
```sql
-- æ—§çš„è§†å›¾å®šä¹‰ï¼ˆç¼ºå°‘ updated_at ç­‰å­—æ®µï¼‰
CREATE VIEW public_users AS
SELECT
    id, name, wins, losses, skill_level, ranking_level,
    ranking_points, break_and_run_count, is_active,
    last_match_date, created_at  â† ç¼ºå°‘ updated_at
FROM users WHERE is_active = true;
```

**é—®é¢˜**ï¼š
- å‰ç«¯çš„ `playerStore.fetchPlayers()` ä½¿ç”¨ `public_users` è§†å›¾
- è§†å›¾å®šä¹‰ä¸å®Œæ•´ï¼Œå¯èƒ½å¯¼è‡´ç¼“å­˜æˆ–æ˜¾ç¤ºé—®é¢˜

**ä¿®å¤**ï¼š
```sql
-- å®Œæ•´çš„è§†å›¾å®šä¹‰
CREATE OR REPLACE VIEW public_users AS
SELECT
    id, name, email, wins, losses, skill_level, ranking_level,
    ranking_points, loyalty_points,
    membership_card_number, membership_level, membership_expires_at,
    membership_balance, break_and_run_count, is_active,
    last_match_date, created_at, updated_at  â† æ·»åŠ æ‰€æœ‰å­—æ®µ
FROM users 
WHERE is_active = true;
```

---

## âœ… å·²å®Œæˆçš„ä¿®å¤

### ä¿®å¤ 1ï¼šæ›´æ–° RLS ç­–ç•¥ âœ…
```sql
DROP POLICY IF EXISTS update_own_or_admin ON users;

CREATE POLICY update_own_or_admin ON users
FOR UPDATE
TO authenticated
USING (
  auth_id = auth.uid()
  OR 
  EXISTS (
    SELECT 1 FROM users 
    WHERE auth_id = auth.uid()  -- âœ… ä½¿ç”¨ auth_id
    AND role = 'admin'
  )
)
WITH CHECK (
  auth_id = auth.uid()
  OR 
  EXISTS (
    SELECT 1 FROM users 
    WHERE auth_id = auth.uid()  -- âœ… ä½¿ç”¨ auth_id
    AND role = 'admin'
  )
);
```

### ä¿®å¤ 2ï¼šé‡æ–°åˆ›å»º public_users è§†å›¾ âœ…
```sql
DROP VIEW IF EXISTS public_users CASCADE;

CREATE OR REPLACE VIEW public_users AS
SELECT
    id, name, email, wins, losses, skill_level, ranking_level,
    ranking_points, loyalty_points,
    membership_card_number, membership_level, membership_expires_at,
    membership_balance, break_and_run_count, is_active,
    last_match_date, created_at, updated_at
FROM users 
WHERE is_active = true;

GRANT SELECT ON public_users TO anon, authenticated;
```

### ä¿®å¤ 3ï¼šé‡ç½®æµ‹è¯•æ•°æ® âœ…
```sql
-- å·²å°† Beilei Zhao é‡ç½®ä¸º 0W-0Lï¼Œæ–¹ä¾¿æµ‹è¯•
UPDATE users
SET wins = 0, losses = 0, break_and_run_count = 0
WHERE name = 'Beilei Zhao';
```

---

## ğŸš€ ç°åœ¨è¯·é‡æ–°æµ‹è¯•

### æµ‹è¯•æ­¥éª¤ï¼ˆå®Œæ•´ç‰ˆï¼‰

#### ç¬¬ä¸€æ­¥ï¼šå¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨
```
Mac: Cmd + Shift + R
Windows: Ctrl + Shift + R
```

**ä¸ºä»€ä¹ˆ**ï¼šç¡®ä¿åŠ è½½æœ€æ–°ä»£ç å’Œè§†å›¾å®šä¹‰

---

#### ç¬¬äºŒæ­¥ï¼šè®¿é—® Players é¡µé¢
```
http://localhost:3000/players
```

---

#### ç¬¬ä¸‰æ­¥ï¼šæ‰¾åˆ° Beilei Zhao
**å½“å‰æ•°æ®**ï¼š0W - 0Lï¼ˆå·²é‡ç½®ï¼‰

---

#### ç¬¬å››æ­¥ï¼šç‚¹å‡» "Edit Stats" æŒ‰é’®

**åº”è¯¥çœ‹åˆ°**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š Edit Statistics: Beilei Zhao       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Current Stats:                         â”‚
â”‚ Wins: 0  Losses: 0  Matches: 0        â”‚
â”‚                                        â”‚
â”‚ ğŸ“ Modification Mode                  â”‚
â”‚ â— â• Increment Mode (Recommended)     â”‚
â”‚   Add results from today's matches    â”‚
â”‚                                        â”‚
â”‚ â—‹ ğŸ”¢ Absolute Mode                    â”‚
â”‚   Set total stats directly            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### ç¬¬äº”æ­¥ï¼šä½¿ç”¨å¢é‡æ¨¡å¼
**ç¡®ä¿é€‰ä¸­**ï¼šâ— â• Increment Mode

**è¾“å…¥æ•°æ®**ï¼š
```
ğŸ’¡ Enter the results from today's matches:

Wins to Add:  [5]
Losses to Add:[3]
Break and Run to Add: [0]
```

**åº”è¯¥çœ‹åˆ°å®æ—¶é¢„è§ˆ**ï¼š
```
ğŸ“Š Preview New Stats:

Wins:           0 + 5 = 5
Losses:         0 + 3 = 3
Matches Played: 0 â†’ 8
Break and Run:  0 + 0 = 0
Win Rate:       0% â†’ 62.50%
```

---

#### ç¬¬å…­æ­¥ï¼šæäº¤
**ç‚¹å‡»**ï¼š"Update Statistics" æŒ‰é’®

**åº”è¯¥çœ‹åˆ°å¼¹çª—**ï¼š
```
Update Beilei Zhao's statistics?

Wins: 0 + 5 = 5
Losses: 0 + 3 = 3
Break and Run: 0 + 0 = 0
```

**ç‚¹å‡»**ï¼š"OK"

---

#### ç¬¬ä¸ƒæ­¥ï¼šéªŒè¯æˆåŠŸ
**åº”è¯¥çœ‹åˆ°æç¤º**ï¼š
```
âœ… Successfully updated Beilei Zhao's statistics incrementally!
```

**é¡µé¢è‡ªåŠ¨åˆ·æ–°å**ï¼š
```
Beilei Zhao çš„æ•°æ®åº”è¯¥å˜ä¸ºï¼š
âœ… 5W - 3L
âœ… Win Rate: 62.50%
âœ… Matches Played: 8
```

---

## ğŸ¯ å¦‚æœè¿˜æ˜¯ä¸è¡Œ

### æ£€æŸ¥æ¸…å•

#### 1. æµè§ˆå™¨å·²å¼ºåˆ¶åˆ·æ–°ï¼Ÿ
```
Cmd + Shift + R (Mac)
Ctrl + Shift + R (Windows)
```

#### 2. å¼€å‘æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼Ÿ
```
http://localhost:3000 èƒ½è®¿é—®å—ï¼Ÿ
```

#### 3. å·²ç™»å½•ç®¡ç†å‘˜è´¦å·ï¼Ÿ
```
å³ä¸Šè§’åº”è¯¥æ˜¾ç¤ºï¼šMax Meng
```

#### 4. æµè§ˆå™¨æ§åˆ¶å°æœ‰é”™è¯¯å—ï¼Ÿ
```
æŒ‰ F12 æ‰“å¼€æ§åˆ¶å°
æŸ¥çœ‹ Console æ ‡ç­¾
æœ‰çº¢è‰²é”™è¯¯å—ï¼Ÿ
```

---

## ğŸ§ª è°ƒè¯•æ–¹æ³•

### åœ¨æµè§ˆå™¨æ§åˆ¶å°æµ‹è¯•

#### æµ‹è¯• 1ï¼šæ£€æŸ¥ Supabase è¿æ¥
```javascript
// æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰ï¼Œç²˜è´´ä»¥ä¸‹ä»£ç ï¼š

const { data, error } = await supabase
  .from('public_users')
  .select('*')
  .eq('name', 'Beilei Zhao');

console.log('Data:', data);
console.log('Error:', error);
```

**æœŸæœ›ç»“æœ**ï¼š
```javascript
Data: [{ name: 'Beilei Zhao', wins: 0, losses: 0, ... }]
Error: null
```

---

#### æµ‹è¯• 2ï¼šæ‰‹åŠ¨æ‰§è¡Œæ›´æ–°
```javascript
// åœ¨æ§åˆ¶å°æ‰§è¡Œï¼š

const { data, error } = await supabase
  .from('users')
  .update({ wins: 5, losses: 3 })
  .eq('name', 'Beilei Zhao')
  .select();

console.log('Update result:', data);
console.log('Update error:', error);
```

**æœŸæœ›ç»“æœ**ï¼š
```javascript
Update result: [{ name: 'Beilei Zhao', wins: 5, losses: 3, ... }]
Update error: null
```

---

#### æµ‹è¯• 3ï¼šæ£€æŸ¥ç®¡ç†å‘˜æƒé™
```javascript
// åœ¨æ§åˆ¶å°æ‰§è¡Œï¼š

const { data: { user } } = await supabase.auth.getUser();
console.log('Current user:', user);

const { data: userProfile } = await supabase
  .from('users')
  .select('name, email, role')
  .eq('auth_id', user.id)
  .single();

console.log('User profile:', userProfile);
```

**æœŸæœ›ç»“æœ**ï¼š
```javascript
Current user: { id: 'ad025733...', email: 'maxmengnz@qq.com', ... }
User profile: { name: 'Max Meng', email: 'maxmengnz@qq.com', role: 'admin' }
```

---

## ğŸ“Š æ•°æ®åº“çŠ¶æ€ç¡®è®¤

### å·²éªŒè¯çš„æ•°æ®

#### Beilei Zhao çš„å½“å‰æ•°æ®
```sql
SELECT name, wins, losses, ranking_points, updated_at
FROM users
WHERE name = 'Beilei Zhao';
```

**ç»“æœ**ï¼š
```
name: Beilei Zhao
wins: 0
losses: 0
ranking_points: 10
updated_at: 2025-11-04 23:37:xx
```

#### public_users è§†å›¾
```sql
SELECT name, wins, losses FROM public_users WHERE name = 'Beilei Zhao';
```

**ç»“æœ**ï¼š
```
name: Beilei Zhao
wins: 0
losses: 0
```

âœ… è§†å›¾æ•°æ®ä¸è¡¨æ•°æ®ä¸€è‡´

---

## ğŸ‰ æ€»ç»“

### å·²ä¿®å¤çš„é—®é¢˜

1. âœ… **RLS ç­–ç•¥**ï¼šä» `id = auth.uid()` æ”¹ä¸º `auth_id = auth.uid()`
2. âœ… **public_users è§†å›¾**ï¼šæ·»åŠ æ‰€æœ‰å¿…è¦å­—æ®µ
3. âœ… **æµ‹è¯•æ•°æ®**ï¼šé‡ç½® Beilei Zhao ä¸º 0W-0L

### åŠŸèƒ½çŠ¶æ€

- âœ… å¢é‡ä¿®æ”¹æ¨¡å¼å·²å®ç°
- âœ… ç»å¯¹å€¼æ¨¡å¼å·²å®ç°
- âœ… å®æ—¶é¢„è§ˆå·²å®ç°
- âœ… RLS æƒé™å·²ä¿®å¤
- âœ… æ•°æ®åº“è§†å›¾å·²æ›´æ–°

---

## ğŸš€ ç°åœ¨å¯ä»¥æµ‹è¯•äº†ï¼

**æ­¥éª¤**ï¼š
1. å¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨ï¼ˆCmd+Shift+Rï¼‰
2. è®¿é—® Players é¡µé¢
3. ç¼–è¾‘ Beilei Zhao
4. ä½¿ç”¨å¢é‡æ¨¡å¼æ·»åŠ  5W-3L
5. æäº¤å¹¶éªŒè¯

**åº”è¯¥çœ‹åˆ°**ï¼š
- âœ… æˆåŠŸæç¤º
- âœ… æ•°æ®ç«‹å³æ›´æ–°ä¸º 5W-3L
- âœ… Win Rate æ˜¾ç¤ºä¸º 62.50%

---

**å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œè¯·å‘Šè¯‰æˆ‘ä½ çœ‹åˆ°çš„å…·ä½“é”™è¯¯ä¿¡æ¯æˆ–æˆªå›¾ï¼** ğŸ’¬

