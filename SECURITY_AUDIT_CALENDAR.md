# ğŸ”’ Calendar Page Security Audit Report

**æ—¥æœŸï¼š** 2025-12-16  
**å®¡è®¡èŒƒå›´ï¼š** Tournament Calendaré¡µé¢åŠç›¸å…³åŠŸèƒ½

---

## âœ… å·²ä¿®å¤çš„å®‰å…¨é—®é¢˜

### 1. **å‚ä¸è€…åˆ—è¡¨ç”¨æˆ·ä¿¡æ¯æ³„éœ²é£é™©** âš ï¸ â†’ âœ…

**é—®é¢˜ï¼š**
- `TournamentsPage.vue`ä¸­æŸ¥è¯¢å‚ä¸è€…æ—¶ï¼Œç›´æ¥JOIN `users`è¡¨
- å¯èƒ½æš´éœ²ç”¨æˆ·çš„emailå’Œphoneç­‰æ•æ„Ÿä¿¡æ¯

**ä¿®å¤ï¼š**
```javascript
// ä¿®å¤å‰ï¼ˆä¸å®‰å…¨ï¼‰
.select(`
  id,
  user_id,
  user:users!tournament_registrations_user_id_fkey(id, name)
`)

// ä¿®å¤åï¼ˆå®‰å…¨ï¼‰
.select(`
  id,
  user_id,
  user:public_users!tournament_registrations_user_id_fkey(id, name)
`)
```

**å½±å“ï¼š**
- âœ… å‚ä¸è€…åˆ—è¡¨ç°åœ¨åªæ˜¾ç¤º`id`å’Œ`name`
- âœ… æ— æ³•é€šè¿‡å‚ä¸è€…åˆ—è¡¨è·å–emailæˆ–phone
- âœ… ç¬¦åˆæœ€å°æƒé™åŸåˆ™

---

### 2. **æ—§ä»£ç æ¸…ç†** ğŸ—‘ï¸ â†’ âœ…

**åˆ é™¤çš„æ–‡ä»¶ï¼š**
- `src/views/TournamentDetailPage.vue` - æ—§çš„æ¯”èµ›è¯¦æƒ…é¡µï¼ˆå·²æ›¿æ¢ä¸ºCalendarï¼‰
- `src/components/TournamentBracket.vue` - æ¯”èµ›å¯¹é˜µè¡¨ç»„ä»¶ï¼ˆä¸å†ä½¿ç”¨ï¼‰

**æ›´æ–°çš„æ–‡ä»¶ï¼š**
- `src/router/index.js` - ç§»é™¤äº†`/tournaments/:id`è·¯ç”±
- `src/views/ProfilePage.vue` - æ›´æ–°äº†é“¾æ¥ï¼Œä»`/tournaments/${id}`æ”¹ä¸º`/tournaments`

**å½±å“ï¼š**
- âœ… å‡å°‘äº†ä»£ç ç»´æŠ¤è´Ÿæ‹…
- âœ… ç§»é™¤äº†æœªä½¿ç”¨çš„åŠŸèƒ½
- âœ… é¿å…äº†æ—§è·¯ç”±å¯èƒ½çš„å®‰å…¨é£é™©

---

## ğŸ”’ å½“å‰å®‰å…¨çŠ¶æ€

### æ•°æ®åº“å±‚å®‰å…¨

#### 1. **`public_users`è§†å›¾** âœ…
```sql
-- åªåŒ…å«å®‰å…¨å­—æ®µ
SELECT 
    id,
    name,
    wins,
    losses,
    skill_level,
    ranking_level,
    ranking_points,
    pro_ranking_points,
    student_ranking_points,
    break_and_run_count,
    is_active,
    created_at,
    -- ... å…¶ä»–éæ•æ„Ÿå­—æ®µ
FROM users
WHERE is_active = true;
```

**å®‰å…¨ç‰¹æ€§ï¼š**
- âœ… ä¸åŒ…å«`email`
- âœ… ä¸åŒ…å«`phone`
- âœ… ä¸åŒ…å«`address`
- âœ… ä¸åŒ…å«`id_card`
- âœ… ä¸åŒ…å«`membership_card_number`
- âœ… ä¸åŒ…å«`auth_id`

#### 2. **`tournament_registrations`è¡¨RLSç­–ç•¥** âœ…

**SELECTç­–ç•¥ï¼š**
```sql
CREATE POLICY "Anyone can view registrations" 
ON tournament_registrations FOR SELECT 
USING (true);
```
- âœ… æ‰€æœ‰äººå¯ä»¥æŸ¥çœ‹æŠ¥åä¿¡æ¯
- âœ… ä½†åªèƒ½é€šè¿‡`public_users`è§†å›¾è·å–ç”¨æˆ·ä¿¡æ¯

**INSERTç­–ç•¥ï¼š**
```sql
CREATE POLICY "Players can register or admins can manage" 
ON tournament_registrations FOR INSERT 
WITH CHECK (
  user_id IN (SELECT id FROM users WHERE auth_id = auth.uid())
  OR EXISTS (SELECT 1 FROM users u WHERE u.auth_id = auth.uid() AND u.role = 'admin')
);
```
- âœ… ç©å®¶åªèƒ½ä¸ºè‡ªå·±æŠ¥å
- âœ… ç®¡ç†å‘˜å¯ä»¥ä¸ºä»»ä½•äººæŠ¥å

**UPDATE/DELETEç­–ç•¥ï¼š**
- âœ… ç©å®¶åªèƒ½å–æ¶ˆè‡ªå·±çš„æŠ¥å
- âœ… ç®¡ç†å‘˜å¯ä»¥ç®¡ç†æ‰€æœ‰æŠ¥å

#### 3. **`users`è¡¨RLSç­–ç•¥** âœ…

**SELECTç­–ç•¥ï¼š**
```sql
CREATE POLICY "user_select_own_or_admin_all" 
ON users FOR SELECT 
USING ((auth_id = auth.uid()) OR is_admin());
```
- âœ… ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„å®Œæ•´ä¿¡æ¯
- âœ… ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯
- âœ… æœªç™»å½•ç”¨æˆ·æ— æ³•ç›´æ¥è®¿é—®`users`è¡¨

**UPDATEç­–ç•¥ï¼š**
```sql
CREATE POLICY "user_update_safe_fields" 
ON users FOR UPDATE 
USING (auth_id = auth.uid())
WITH CHECK (
  -- åªèƒ½æ›´æ–°å®‰å…¨å­—æ®µï¼Œä¸èƒ½ä¿®æ”¹roleã€is_activeç­‰æ•æ„Ÿå­—æ®µ
);
```
- âœ… ç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±çš„å®‰å…¨å­—æ®µ
- âœ… æ— æ³•ä¿®æ”¹roleã€is_activeç­‰æ•æ„Ÿå­—æ®µ

---

### å‰ç«¯å±‚å®‰å…¨

#### 1. **å‚ä¸è€…åˆ—è¡¨æ˜¾ç¤º** âœ…

**å½“å‰å®ç°ï¼š**
```vue
<div v-for="(participant, idx) in participantsList" :key="participant.id">
  <span>{{ participant.user?.name || 'Unknown' }}</span>
</div>
```

**å®‰å…¨ç‰¹æ€§ï¼š**
- âœ… åªæ˜¾ç¤º`name`ï¼Œä¸æ˜¾ç¤ºemail/phone
- âœ… ä½¿ç”¨`public_users`è§†å›¾ï¼Œç¡®ä¿æ— æ³•è·å–æ•æ„Ÿä¿¡æ¯
- âœ… å³ä½¿å‰ç«¯è¢«æ¶æ„ä¿®æ”¹ï¼Œä¹Ÿæ— æ³•è·å–æ•æ„Ÿæ•°æ®ï¼ˆæ•°æ®åº“å±‚ä¿æŠ¤ï¼‰

#### 2. **æ³¨å†ŒåŠŸèƒ½** âœ…

**å½“å‰å®ç°ï¼š**
```javascript
const registerForEvent = async () => {
  // ä½¿ç”¨currentUserIdï¼ˆä»authStoreè·å–ï¼‰
  const { error } = await supabase
    .from('tournament_registrations')
    .insert([{
      tournament_id: selectedEvent.value.id,
      user_id: currentUserId.value,
      status: 'registered'
    }])
}
```

**å®‰å…¨ç‰¹æ€§ï¼š**
- âœ… ä½¿ç”¨è®¤è¯åçš„`user_id`ï¼Œæ— æ³•ä¼ªé€ 
- âœ… RLSç­–ç•¥ç¡®ä¿åªèƒ½ä¸ºè‡ªå·±æŠ¥å
- âœ… ç®¡ç†å‘˜å¯ä»¥ä»£ä¸ºæŠ¥åï¼ˆåˆç†éœ€æ±‚ï¼‰

#### 3. **ç®¡ç†å‘˜åŠŸèƒ½** âœ…

**è®¿é—®æ§åˆ¶ï¼š**
```vue
<div v-if="authStore.isAdmin">
  <!-- ç®¡ç†å‘˜ä¸“å±åŠŸèƒ½ -->
</div>
```

**å®‰å…¨ç‰¹æ€§ï¼š**
- âœ… å‰ç«¯æ£€æŸ¥`authStore.isAdmin`
- âœ… åç«¯RLSç­–ç•¥åŒé‡éªŒè¯
- âœ… å³ä½¿å‰ç«¯è¢«ç»•è¿‡ï¼Œåç«¯ä¹Ÿä¼šæ‹’ç»æœªæˆæƒæ“ä½œ

---

## ğŸ›¡ï¸ é˜²æŠ¤æªæ–½æ€»ç»“

### å¤šå±‚é˜²æŠ¤æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯å±‚ (Vue Components)            â”‚
â”‚  - ä½¿ç”¨public_usersè§†å›¾              â”‚
â”‚  - æ¡ä»¶æ¸²æŸ“ï¼ˆv-if="authStore.isAdmin"ï¼‰â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®è®¿é—®å±‚ (Supabase Client)       â”‚
â”‚  - è‡ªåŠ¨åº”ç”¨RLSç­–ç•¥                   â”‚
â”‚  - ä½¿ç”¨public_usersè§†å›¾              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®åº“å±‚ (PostgreSQL RLS)          â”‚
â”‚  - RLSç­–ç•¥å¼ºåˆ¶æ‰§è¡Œ                  â”‚
â”‚  - public_usersè§†å›¾é™åˆ¶å­—æ®µ         â”‚
â”‚  - æ— æ³•ç»•è¿‡çš„å®‰å…¨è¾¹ç•Œ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•æ„Ÿä¿¡æ¯ä¿æŠ¤

| ä¿¡æ¯ç±»å‹ | å…¬å¼€è®¿é—® | ç™»å½•ç”¨æˆ· | ç®¡ç†å‘˜ |
|---------|---------|---------|--------|
| **å§“å (name)** | âœ… | âœ… | âœ… |
| **Email** | âŒ | ä»…è‡ªå·± | âœ… |
| **Phone** | âŒ | ä»…è‡ªå·± | âœ… |
| **åœ°å€ (address)** | âŒ | ä»…è‡ªå·± | âœ… |
| **èº«ä»½è¯ (id_card)** | âŒ | ä»…è‡ªå·± | âœ… |
| **ä¼šå‘˜å¡å·** | âŒ | ä»…è‡ªå·± | âœ… |
| **èƒœè´Ÿè®°å½•** | âœ… | âœ… | âœ… |
| **æ’åç§¯åˆ†** | âœ… | âœ… | âœ… |

---

## âœ… å®‰å…¨éªŒè¯æ¸…å•

- [x] `public_users`è§†å›¾ä¸åŒ…å«email/phone
- [x] `tournament_registrations`æŸ¥è¯¢ä½¿ç”¨`public_users`è§†å›¾
- [x] RLSç­–ç•¥æ­£ç¡®é…ç½®
- [x] å‚ä¸è€…åˆ—è¡¨åªæ˜¾ç¤ºname
- [x] æ³¨å†ŒåŠŸèƒ½ä½¿ç”¨è®¤è¯åçš„user_id
- [x] ç®¡ç†å‘˜åŠŸèƒ½æœ‰åŒé‡éªŒè¯
- [x] æ—§ä»£ç å·²æ¸…ç†
- [x] è·¯ç”±å·²æ›´æ–°

---

## ğŸ¯ å»ºè®®

### å½“å‰çŠ¶æ€ï¼šâœ… **å®‰å…¨**

æ‰€æœ‰å·²è¯†åˆ«çš„å®‰å…¨é—®é¢˜éƒ½å·²ä¿®å¤ã€‚Calendaré¡µé¢ç°åœ¨ï¼š

1. âœ… **ä¸ä¼šæ³„éœ²ç”¨æˆ·æ•æ„Ÿä¿¡æ¯**ï¼ˆemailã€phoneç­‰ï¼‰
2. âœ… **ä½¿ç”¨å®‰å…¨çš„æ•°æ®åº“è§†å›¾**ï¼ˆ`public_users`ï¼‰
3. âœ… **æœ‰å®Œå–„çš„RLSç­–ç•¥ä¿æŠ¤**
4. âœ… **æ—§ä»£ç å·²æ¸…ç†**ï¼Œå‡å°‘æ”»å‡»é¢

### æŒç»­ç›‘æ§

å»ºè®®å®šæœŸæ£€æŸ¥ï¼š
- [ ] æ–°å¢çš„æŸ¥è¯¢æ˜¯å¦ä½¿ç”¨`public_users`è§†å›¾
- [ ] RLSç­–ç•¥æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
- [ ] æ˜¯å¦æœ‰æ–°çš„æ•æ„Ÿå­—æ®µéœ€è¦ä¿æŠ¤

---

## ğŸ“ å˜æ›´è®°å½•

**2025-12-16:**
- âœ… ä¿®å¤å‚ä¸è€…åˆ—è¡¨æŸ¥è¯¢ï¼Œä½¿ç”¨`public_users`è§†å›¾
- âœ… åˆ é™¤æ—§çš„`TournamentDetailPage.vue`å’Œ`TournamentBracket.vue`
- âœ… æ›´æ–°è·¯ç”±é…ç½®
- âœ… æ›´æ–°`ProfilePage.vue`ä¸­çš„é“¾æ¥

---

**å®¡è®¡å®Œæˆ âœ…**

