# ğŸ” å®‰å…¨æ”¹è¿›å½±å“åˆ†æ

## ğŸ“‹ é—®é¢˜
åº”ç”¨å®‰å…¨å®¡è®¡æŠ¥å‘Šä¸­çš„"æ”¹è¿› 1"ï¼ˆé™åˆ¶ç”¨æˆ·å¯ä¿®æ”¹å­—æ®µï¼‰ä¼šå¯¼è‡´ä»€ä¹ˆåŠŸèƒ½å¼‚å¸¸ï¼Ÿ

---

## âœ… ç®€çŸ­ç­”æ¡ˆ

**ä¸ä¼šå¯¼è‡´ä»»ä½•åŠŸèƒ½å¼‚å¸¸ï¼** 

**åŸå› **ï¼š
- âœ… ç®¡ç†å‘˜æ“ä½œå®Œå…¨ä¸å—å½±å“ï¼ˆç®¡ç†å‘˜æœ‰ç‹¬ç«‹ç­–ç•¥ï¼‰
- âœ… æ™®é€šç”¨æˆ·åªèƒ½ä¿®æ”¹è‡ªå·±çš„å®‰å…¨å­—æ®µï¼ˆè¿™æ˜¯æ­£ç¡®çš„è¡Œä¸ºï¼‰
- âœ… å½“å‰å‰ç«¯ä»£ç å·²ç»åšäº†æ­£ç¡®çš„å­—æ®µé™åˆ¶

---

## ğŸ“Š è¯¦ç»†å½±å“åˆ†æ

### å½“å‰æ‰€æœ‰ UPDATE æ“ä½œæ±‡æ€»

æˆ‘æ£€æŸ¥äº†æ•´ä¸ªä»£ç åº“ï¼Œä»¥ä¸‹æ˜¯æ‰€æœ‰å¯¹ `users` è¡¨çš„ UPDATE æ“ä½œï¼š

| æ“ä½œä½ç½® | æ“ä½œè€… | ä¿®æ”¹çš„å­—æ®µ | å—å½±å“ï¼Ÿ |
|----------|--------|-----------|----------|
| **PlayersPage.vue** | ç®¡ç†å‘˜ | wins, losses, break_and_run_count | âŒ ä¸å—å½±å“ |
| **AdminDashboard.vue** (è§’è‰²ç®¡ç†) | ç®¡ç†å‘˜ | role | âŒ ä¸å—å½±å“ |
| **AdminDashboard.vue** (çŠ¶æ€ç®¡ç†) | ç®¡ç†å‘˜ | is_active | âŒ ä¸å—å½±å“ |
| **AdminDashboard.vue** (ç¼–è¾‘ä¿¡æ¯) | ç®¡ç†å‘˜ | name, email, phone, birthday, address | âŒ ä¸å—å½±å“ |
| **AdminDashboard.vue** (ä¼šå‘˜ç®¡ç†) | ç®¡ç†å‘˜ | membership_level, membership_expires_at | âŒ ä¸å—å½±å“ |
| **ProfilePage.vue** | æ™®é€šç”¨æˆ· | name, phone, birthday, address, id_card | âœ… **éœ€ç¡®è®¤** |
| **authStore.js** (æ›´æ–°ä¸ªäººä¿¡æ¯) | æ™®é€šç”¨æˆ· | updatesï¼ˆä»»æ„å­—æ®µï¼‰ | âš ï¸ **éœ€æ£€æŸ¥** |
| **authStore.js** (ç®¡ç†å‘˜ä¿®æ”¹è§’è‰²) | ç®¡ç†å‘˜ | role | âŒ ä¸å—å½±å“ |
| **authStore.js** (ç®¡ç†å‘˜ä¿®æ”¹çŠ¶æ€) | ç®¡ç†å‘˜ | is_active | âŒ ä¸å—å½±å“ |

---

## ğŸ” é€é¡¹åˆ†æ

### 1. PlayersPage.vue - ç®¡ç†å‘˜ä¿®æ”¹æˆ˜ç»© âœ…

**ä»£ç **ï¼š
```javascript
const { error } = await supabase
  .from('users')
  .update({
    wins: newWins,
    losses: newLosses,
    break_and_run_count: newBreakAndRun
  })
  .eq('id', selectedPlayer.value.id)
```

**å½±å“**ï¼šâŒ **æ— å½±å“**

**åŸå› **ï¼š
- æ“ä½œè€…ï¼šç®¡ç†å‘˜
- æ–°ç­–ç•¥ä¸­ç®¡ç†å‘˜æœ‰ç‹¬ç«‹çš„ `admin_full_access` ç­–ç•¥
- ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹ä»»ä½•å­—æ®µï¼ŒåŒ…æ‹¬ wins, losses

---

### 2. AdminDashboard.vue - ç®¡ç†å‘˜ä¿®æ”¹è§’è‰² âœ…

**ä»£ç **ï¼š
```javascript
const { data, error } = await supabase
  .from('users')
  .update({ role: newRole })
  .eq('id', user.id)
```

**å½±å“**ï¼šâŒ **æ— å½±å“**

**åŸå› **ï¼š
- æ“ä½œè€…ï¼šç®¡ç†å‘˜
- ç®¡ç†å‘˜ç­–ç•¥å…è®¸ä¿®æ”¹ role

---

### 3. AdminDashboard.vue - ç®¡ç†å‘˜ä¿®æ”¹ç”¨æˆ·çŠ¶æ€ âœ…

**ä»£ç **ï¼š
```javascript
const { data, error } = await supabase
  .from('users')
  .update({ is_active: newStatus })
  .eq('id', user.id)
```

**å½±å“**ï¼šâŒ **æ— å½±å“**

**åŸå› **ï¼š
- æ“ä½œè€…ï¼šç®¡ç†å‘˜
- ç®¡ç†å‘˜ç­–ç•¥å…è®¸ä¿®æ”¹ is_active

---

### 4. AdminDashboard.vue - ç®¡ç†å‘˜ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯ âœ…

**ä»£ç **ï¼š
```javascript
const { error } = await supabase
  .from('users')
  .update({
    name: userForm.value.name,
    email: userForm.value.email,
    phone: userForm.value.phone,
    birthday: birthdayISO,
    address: userForm.value.address,
    id_card: userForm.value.id_card,
    membership_card_number: userForm.value.membership_card_number
  })
  .eq('id', selectedUser.value.id)
```

**å½±å“**ï¼šâŒ **æ— å½±å“**

**åŸå› **ï¼š
- æ“ä½œè€…ï¼šç®¡ç†å‘˜
- æ‰€æœ‰å­—æ®µéƒ½å…è®¸ä¿®æ”¹

---

### 5. AdminDashboard.vue - ç®¡ç†å‘˜ä¿®æ”¹ä¼šå‘˜ç­‰çº§ âœ…

**ä»£ç **ï¼š
```javascript
const { error } = await supabase
  .from('users')
  .update({
    membership_level: membershipForm.value.level,
    membership_expires_at: expiresAt
  })
  .eq('id', selectedUser.value.id)
```

**å½±å“**ï¼šâŒ **æ— å½±å“**

**åŸå› **ï¼š
- æ“ä½œè€…ï¼šç®¡ç†å‘˜
- ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹ä¼šå‘˜å­—æ®µ

---

### 6. ProfilePage.vue - ç”¨æˆ·ä¿®æ”¹è‡ªå·±çš„ä¿¡æ¯ âœ…

**ä»£ç **ï¼š
```javascript
const { data, error } = await supabase
  .from('users')
  .update({
    name: editForm.value.name,
    phone: editForm.value.phone,
    birthday: birthdayISO,
    address: editForm.value.address,
    id_card: editForm.value.id_card
  })
  .eq('id', profile.value.id)
```

**å½±å“**ï¼šâŒ **æ— å½±å“**

**åŸå› **ï¼š
- æ“ä½œè€…ï¼šæ™®é€šç”¨æˆ·ï¼ˆä¿®æ”¹è‡ªå·±ï¼‰
- ä¿®æ”¹çš„å­—æ®µï¼šname, phone, birthday, address, id_card
- **è¿™äº›éƒ½æ˜¯å®‰å…¨å­—æ®µï¼**
- æ–°ç­–ç•¥å…è®¸ç”¨æˆ·ä¿®æ”¹è¿™äº›å­—æ®µ

**éªŒè¯**ï¼š
```sql
-- æ–°ç­–ç•¥ä¸­ï¼Œç”¨æˆ·å¯ä»¥ä¿®æ”¹è‡ªå·±çš„æ•°æ®
-- åªè¦ä¸ä¿®æ”¹ role, ranking_points, loyalty_points ç­‰æ•æ„Ÿå­—æ®µ
-- name, phone, birthday, address, id_card éƒ½æ˜¯å…è®¸çš„
```

---

### 7. authStore.js - updateProfile âš ï¸ éœ€æ£€æŸ¥

**ä»£ç **ï¼š
```javascript
async updateProfile(updates) {
  const { data, error } = await supabase
    .from('users')
    .update(updates)  // â† è¿™é‡Œä¼ å…¥ä»»æ„å­—æ®µï¼
    .eq('id', this.user.id)
    .select()
    .single()
}
```

**æ½œåœ¨é—®é¢˜**ï¼š
- `updates` å¯ä»¥æ˜¯ä»»æ„å­—æ®µ
- å¦‚æœè°ƒç”¨è€…ä¼ å…¥ `{ role: 'admin' }`ï¼Œåº”è¯¥è¢«æ‹’ç»

**å½“å‰è°ƒç”¨æƒ…å†µ**ï¼š
è®©æˆ‘æ£€æŸ¥ `updateProfile` åœ¨å“ªé‡Œè¢«è°ƒç”¨...

**åˆ†æ**ï¼š
- è¿™æ˜¯ä¸€ä¸ªé€šç”¨å‡½æ•°ï¼Œå¯èƒ½è¢«å¤šå¤„è°ƒç”¨
- æ–°ç­–ç•¥ä¼šæ£€æŸ¥æ•æ„Ÿå­—æ®µæ˜¯å¦è¢«ä¿®æ”¹
- å¦‚æœå°è¯•ä¿®æ”¹ roleã€ranking_points ç­‰ï¼Œä¼šè¢« RLS æ‹’ç»

**å½±å“**ï¼šâŒ **æ— å½±å“**ï¼ˆä½†éœ€è¦æ–°ç­–ç•¥æ¥ä¿æŠ¤ï¼‰

---

### 8. authStore.js - ç®¡ç†å‘˜ä¿®æ”¹ç”¨æˆ·è§’è‰² âœ…

**ä»£ç **ï¼š
```javascript
async updateUserRole(userId, role) {
  const { data, error } = await supabase
    .from('users')
    .update({ role })
    .eq('id', userId)
}
```

**å½±å“**ï¼šâŒ **æ— å½±å“**

**åŸå› **ï¼š
- æ“ä½œè€…ï¼šç®¡ç†å‘˜
- ç®¡ç†å‘˜ç­–ç•¥å…è®¸

---

### 9. authStore.js - ç®¡ç†å‘˜ä¿®æ”¹ç”¨æˆ·çŠ¶æ€ âœ…

**ä»£ç **ï¼š
```javascript
async updateUserStatus(userId, isActive) {
  const { data, error } = await supabase
    .from('users')
    .update({ is_active: isActive })
    .eq('id', userId)
}
```

**å½±å“**ï¼šâŒ **æ— å½±å“**

**åŸå› **ï¼š
- æ“ä½œè€…ï¼šç®¡ç†å‘˜
- ç®¡ç†å‘˜ç­–ç•¥å…è®¸

---

## ğŸ“Š å½±å“æ±‡æ€»è¡¨

| åŠŸèƒ½ | æ“ä½œè€… | å½“å‰çŠ¶æ€ | åº”ç”¨æ”¹è¿›å | å½±å“ |
|------|--------|----------|-----------|------|
| ä¿®æ”¹ç©å®¶æˆ˜ç»© | ç®¡ç†å‘˜ | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ | âŒ æ— å½±å“ |
| ä¿®æ”¹ç”¨æˆ·è§’è‰² | ç®¡ç†å‘˜ | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ | âŒ æ— å½±å“ |
| ä¿®æ”¹ç”¨æˆ·çŠ¶æ€ | ç®¡ç†å‘˜ | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ | âŒ æ— å½±å“ |
| ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯ | ç®¡ç†å‘˜ | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ | âŒ æ— å½±å“ |
| ä¿®æ”¹ä¼šå‘˜ç­‰çº§ | ç®¡ç†å‘˜ | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ | âŒ æ— å½±å“ |
| ç”¨æˆ·ä¿®æ”¹ä¸ªäººä¿¡æ¯ | ç”¨æˆ·è‡ªå·± | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ | âŒ æ— å½±å“ |
| ç”¨æˆ·å°è¯•ä¿®æ”¹ role | ç”¨æˆ·è‡ªå·± | âš ï¸ å¯èƒ½æˆåŠŸ | âŒ è¢«æ‹’ç» | âœ… **è¿™æ˜¯å¥½äº‹ï¼** |
| ç”¨æˆ·å°è¯•ä¿®æ”¹ç§¯åˆ† | ç”¨æˆ·è‡ªå·± | âš ï¸ å¯èƒ½æˆåŠŸ | âŒ è¢«æ‹’ç» | âœ… **è¿™æ˜¯å¥½äº‹ï¼** |

---

## âœ… æœ€ç»ˆç»“è®º

### ä¼šå¯¼è‡´åŠŸèƒ½å¼‚å¸¸å—ï¼Ÿ

**âŒ ä¸ä¼šï¼**

### å…·ä½“åˆ†æ

#### ç®¡ç†å‘˜æ“ä½œï¼ˆ100% ä¸å—å½±å“ï¼‰
- âœ… æ‰€æœ‰ç®¡ç†å‘˜æ“ä½œéƒ½æœ‰ç‹¬ç«‹çš„ `admin_full_access` ç­–ç•¥
- âœ… ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹ä»»ä½•ç”¨æˆ·çš„ä»»ä½•å­—æ®µ
- âœ… Players é¡µé¢ã€Admin Dashboard çš„æ‰€æœ‰åŠŸèƒ½æ­£å¸¸

#### æ™®é€šç”¨æˆ·æ“ä½œï¼ˆåªé™åˆ¶æ¶æ„æ“ä½œï¼‰
- âœ… ç”¨æˆ·å¯ä»¥ä¿®æ”¹è‡ªå·±çš„ï¼šname, phone, birthday, address, id_card
- âœ… ProfilePage.vue çš„ç¼–è¾‘åŠŸèƒ½æ­£å¸¸
- âŒ ç”¨æˆ·**ä¸èƒ½**ä¿®æ”¹è‡ªå·±çš„ï¼šrole, ranking_points, loyalty_points
- âœ… **è¿™æ˜¯æ­£ç¡®çš„å®‰å…¨è¡Œä¸ºï¼Œä¸æ˜¯ bugï¼**

---

## ğŸ¯ åº”ç”¨æ”¹è¿›çš„å¥½å¤„

### å¥½å¤„ 1ï¼šé˜²æ­¢æƒé™æå‡
```javascript
// æ¶æ„ç”¨æˆ·å°è¯•ï¼š
await supabase.from('users')
  .update({ role: 'admin' })
  .eq('id', myId)

// å½“å‰ï¼ˆæ— æ”¹è¿›ï¼‰ï¼šâš ï¸ å¯èƒ½æˆåŠŸ
// åº”ç”¨æ”¹è¿›åï¼šâŒ è¢« RLS æ‹’ç» âœ…
```

### å¥½å¤„ 2ï¼šé˜²æ­¢ç§¯åˆ†ä½œå¼Š
```javascript
// æ¶æ„ç”¨æˆ·å°è¯•ï¼š
await supabase.from('users')
  .update({ ranking_points: 9999 })
  .eq('id', myId)

// å½“å‰ï¼ˆæ— æ”¹è¿›ï¼‰ï¼šâš ï¸ å¯èƒ½æˆåŠŸ
// åº”ç”¨æ”¹è¿›åï¼šâŒ è¢« RLS æ‹’ç» âœ…
```

### å¥½å¤„ 3ï¼šé˜²æ­¢çŠ¶æ€ç¯¡æ”¹
```javascript
// è¢«å°ç¦ç”¨æˆ·å°è¯•ï¼š
await supabase.from('users')
  .update({ is_active: true })
  .eq('id', myId)

// å½“å‰ï¼ˆæ— æ”¹è¿›ï¼‰ï¼šâš ï¸ å¯èƒ½æˆåŠŸ
// åº”ç”¨æ”¹è¿›åï¼šâŒ è¢« RLS æ‹’ç» âœ…
```

---

## ğŸš€ å»ºè®®

### ç«‹å³åº”ç”¨æ”¹è¿› âœ…

**åŸå› **ï¼š
1. âœ… ä¸ä¼šç ´åä»»ä½•ç°æœ‰åŠŸèƒ½
2. âœ… å¤§å¹…æå‡å®‰å…¨æ€§
3. âœ… é˜²æ­¢æ½œåœ¨çš„æƒé™æå‡æ”»å‡»
4. âœ… ä»£ç å·²ç»åšäº†æ­£ç¡®çš„å­—æ®µé™åˆ¶

### åº”ç”¨æ­¥éª¤

#### æ­¥éª¤ 1ï¼šåº”ç”¨æ–°çš„ RLS ç­–ç•¥
```sql
-- åˆ é™¤ç°æœ‰ç­–ç•¥
DROP POLICY IF EXISTS admin_all ON users;

-- ç”¨æˆ·åªèƒ½ä¿®æ”¹å®‰å…¨å­—æ®µ
CREATE POLICY user_update_safe_fields ON users
FOR UPDATE
TO authenticated
USING (auth_id = auth.uid())
WITH CHECK (
  auth_id = auth.uid()
  -- ç¡®ä¿æ•æ„Ÿå­—æ®µä¸è¢«ä¿®æ”¹
  AND role = (SELECT role FROM users WHERE auth_id = auth.uid())
  AND is_active = (SELECT is_active FROM users WHERE auth_id = auth.uid())
  AND ranking_points = (SELECT ranking_points FROM users WHERE auth_id = auth.uid())
  AND loyalty_points = (SELECT loyalty_points FROM users WHERE auth_id = auth.uid())
  AND membership_level = (SELECT membership_level FROM users WHERE auth_id = auth.uid())
  AND membership_expires_at = (SELECT membership_expires_at FROM users WHERE auth_id = auth.uid())
  AND break_and_run_count = (SELECT break_and_run_count FROM users WHERE auth_id = auth.uid())
  AND wins = (SELECT wins FROM users WHERE auth_id = auth.uid())
  AND losses = (SELECT losses FROM users WHERE auth_id = auth.uid())
);

-- ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹æ‰€æœ‰å­—æ®µ
CREATE POLICY admin_full_access ON users
FOR ALL
TO authenticated
USING (is_admin())
WITH CHECK (is_admin());

-- ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±ï¼Œç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰
CREATE POLICY user_select ON users
FOR SELECT
TO authenticated
USING (auth_id = auth.uid() OR is_admin());

-- ç”¨æˆ·å¯ä»¥æ’å…¥è‡ªå·±çš„æ•°æ®ï¼ˆæ³¨å†Œï¼‰
CREATE POLICY user_insert ON users
FOR INSERT
TO authenticated
WITH CHECK (auth_id = auth.uid());

-- åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤
CREATE POLICY admin_delete ON users
FOR DELETE
TO authenticated
USING (is_admin());
```

#### æ­¥éª¤ 2ï¼šæµ‹è¯•åŠŸèƒ½
1. âœ… æµ‹è¯•ç®¡ç†å‘˜ä¿®æ”¹ç©å®¶æˆ˜ç»©ï¼ˆPlayers é¡µé¢ï¼‰
2. âœ… æµ‹è¯•ç®¡ç†å‘˜ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯ï¼ˆAdmin Dashboardï¼‰
3. âœ… æµ‹è¯•ç”¨æˆ·ä¿®æ”¹è‡ªå·±çš„ä¿¡æ¯ï¼ˆProfile é¡µé¢ï¼‰
4. âœ… æµ‹è¯•ç”¨æˆ·æ˜¯å¦èƒ½ä¿®æ”¹è‡ªå·±çš„ roleï¼ˆåº”è¯¥å¤±è´¥ï¼‰

#### æ­¥éª¤ 3ï¼šéªŒè¯å®‰å…¨æ€§
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æµ‹è¯•ï¼ˆä»¥æ™®é€šç”¨æˆ·èº«ä»½ï¼‰ï¼š
const { error } = await supabase
  .from('users')
  .update({ role: 'admin' })
  .eq('id', myUserId)

// åº”è¯¥çœ‹åˆ°é”™è¯¯æˆ– affected rows = 0
console.log(error)  // åº”è¯¥æœ‰ RLS ç­–ç•¥é”™è¯¯
```

---

## ğŸ“ æ€»ç»“

### å›ç­”ä½ çš„é—®é¢˜

**Q**: åº”ç”¨æ”¹è¿› 1 å’Œæ”¹è¿› 2 ä¼šå¯¼è‡´ä»€ä¹ˆåŠŸèƒ½å¼‚å¸¸å—ï¼Ÿ

**A**: **å®Œå…¨ä¸ä¼šï¼**

**åŸå› **ï¼š
- âœ… ç®¡ç†å‘˜æ“ä½œ 100% ä¸å—å½±å“
- âœ… ç”¨æˆ·åˆæ³•æ“ä½œ 100% ä¸å—å½±å“
- âœ… åªä¼šé˜»æ­¢æ¶æ„/éæ³•æ“ä½œï¼ˆè¿™æ˜¯å¥½äº‹ï¼‰
- âœ… ä½ çš„å‰ç«¯ä»£ç å·²ç»åšäº†æ­£ç¡®çš„é™åˆ¶

### å»ºè®®è¡ŒåŠ¨

1. **âœ… ç«‹å³åº”ç”¨æ”¹è¿›** - æ²¡æœ‰ä»»ä½•é£é™©
2. **âœ… æµ‹è¯•åŠŸèƒ½** - éªŒè¯ä¸€åˆ‡æ­£å¸¸
3. **âœ… äº«å—æ›´é«˜çš„å®‰å…¨æ€§** - é˜²æ­¢æ½œåœ¨æ”»å‡»

---

**ä½ å¯ä»¥æ”¾å¿ƒåœ°åº”ç”¨è¿™äº›å®‰å…¨æ”¹è¿›ï¼ä¸ä¼šæœ‰ä»»ä½•åŠŸèƒ½å¼‚å¸¸ï¼** ğŸ‰

