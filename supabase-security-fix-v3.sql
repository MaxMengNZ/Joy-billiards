-- ============================================
-- 🔐 修复 public_users 视图 - 移除邮箱
-- 感谢社区安全研究员的建议
-- ============================================

-- 问题：public_users 视图包含邮箱地址
-- 风险：网站爬虫可以抓取所有用户邮箱
-- 解决：只显示必要的公开信息

-- ============================================
-- 1. 删除旧的 public_users 视图
-- ============================================

DROP VIEW IF EXISTS public_users;

-- ============================================
-- 2. 创建新的安全视图（不包含邮箱）
-- ============================================

CREATE OR REPLACE VIEW public_users AS
SELECT 
    id,
    name,
    wins,
    losses,
    skill_level,
    created_at
FROM users
WHERE is_active = true;

-- 只显示公开信息：
-- ✅ id - 用于关联数据
-- ✅ name - 玩家姓名
-- ✅ wins - 胜场
-- ✅ losses - 负场
-- ✅ skill_level - 技能等级
-- ✅ created_at - 注册时间
-- ❌ email - 移除（防止爬虫）
-- ❌ phone - 移除（敏感信息）

-- 允许所有人查看公开用户信息
GRANT SELECT ON public_users TO anon, authenticated;

-- ============================================
-- 3. 更新 get_all_users RPC（管理员专用）
-- ============================================

-- 这个函数保持不变，包含完整信息（只有管理员能调用）
-- 由应用层控制访问权限

-- ============================================
-- 4. 成功消息
-- ============================================

DO $$
BEGIN
    RAISE NOTICE '✅ public_users 视图已更新！';
    RAISE NOTICE '✅ 邮箱地址已从公开视图中移除';
    RAISE NOTICE '✅ 防止网站爬虫抓取用户邮箱';
    RAISE NOTICE '';
    RAISE NOTICE '感谢社区安全研究员的建议！';
END $$;

