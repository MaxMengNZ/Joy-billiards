# 👤 用户权限说明

**更新时间：** 2025年11月3日  
**当前 RLS 策略：** 最简化版本（无递归）

---

## 📝 用户可以修改的字段

### ✅ 普通用户（在 Profile 页面）

**可以查看：**
- ✅ 所有自己的信息（包括敏感信息）

**可以修改（点击 "Edit Profile"）：**
1. ✅ **Full Name**（姓名）
2. ✅ **Phone**（电话）
3. ✅ **Date of Birth**（生日）
4. ✅ **Address**（地址）
5. ✅ **ID Card / Driver License**（身份证/驾照号）
6. ✅ **Password**（密码 - 通过 "Change Password" 按钮）

**不能修改（只读或系统管理）：**
- ❌ Email（邮箱） - 显示"Email cannot be changed"
- ❌ Membership Level（会员等级） - 只能管理员修改
- ❌ Membership Card Number（会员卡号） - 系统生成
- ❌ Loyalty Points（消费积分） - 只能管理员添加
- ❌ Ranking Points（段位积分） - 只能管理员添加
- ❌ Ranking Level（段位等级） - 系统自动计算
- ❌ Wins/Losses（胜负场） - 系统自动记录
- ❌ Break & Run Count - 只能管理员修改
- ❌ Role（角色） - 只能管理员修改
- ❌ Is Active（账号状态） - 只能管理员修改

---

## 👑 管理员可以修改的字段

### ✅ 管理员（在 Admin Dashboard）

**可以查看：**
- ✅ 所有用户的所有信息

**可以修改：**
1. ✅ **所有基本信息**（姓名、电话、地址等）
2. ✅ **会员等级**（Lite/Plus/Pro/Pro Max）
3. ✅ **会员卡号**
4. ✅ **会员到期时间**
5. ✅ **Loyalty Points**（消费积分）- 通过 "💰 Loyalty" 按钮
6. ✅ **Ranking Points**（段位积分）- 通过 Players 页面
7. ✅ **Break & Run Count**
8. ✅ **Role**（角色）- Admin ↔ Player
9. ✅ **Is Active**（激活/停用账号）
10. ✅ **Account Balance**（账户余额）

---

## 🔒 安全限制

### 用户的限制：
**通过 RLS 策略控制：**
```sql
-- 用户只能查看和修改自己的数据
USING (auth_id = auth.uid())
WITH CHECK (auth_id = auth.uid())
```

**通过前端代码控制：**
- 敏感字段设置为 `disabled`
- 只有管理员才能看到某些按钮

### 数据库级别保护：
**即使用户试图通过 API 修改：**
- ❌ 修改别人的数据 → RLS 阻止
- ❌ 修改自己的积分 → UPDATE 不包含这些字段
- ❌ 修改自己的角色 → UPDATE 不包含这些字段

---

## 📊 字段权限矩阵

| 字段 | 用户查看 | 用户修改 | 管理员查看 | 管理员修改 |
|------|---------|---------|-----------|-----------|
| **基本信息** | | | | |
| Name | ✅ | ✅ | ✅ | ✅ |
| Email | ✅ | ❌ | ✅ | ❌ |
| Phone | ✅ | ✅ | ✅ | ✅ |
| Birthday | ✅ | ✅ | ✅ | ✅ |
| Address | ✅ | ✅ | ✅ | ✅ |
| ID Card | ✅ | ✅ | ✅ | ✅ |
| Password | ✅ | ✅ | ✅ | ❌ |
| **会员信息** | | | | |
| Membership Level | ✅ | ❌ | ✅ | ✅ |
| Membership Card # | ✅ | ❌ | ✅ | ✅ |
| Membership Expires | ✅ | ❌ | ✅ | ✅ |
| Account Balance | ✅ | ❌ | ✅ | ✅ |
| Loyalty Points | ✅ | ❌ | ✅ | ✅ |
| **游戏数据** | | | | |
| Ranking Points | ✅ | ❌ | ✅ | ✅ |
| Ranking Level | ✅ | ❌ | ✅ | ✅ |
| Wins/Losses | ✅ | ❌ | ✅ | ✅ |
| Break & Run | ✅ | ❌ | ✅ | ✅ |
| **系统字段** | | | | |
| Role | ✅ | ❌ | ✅ | ✅ |
| Is Active | ✅ | ❌ | ✅ | ✅ |

---

## 🎯 用户修改流程

### 在 Profile 页面：

1. **点击 "Edit Profile" 按钮**
2. **修改可编辑字段：**
   - 姓名
   - 电话
   - 生日
   - 地址
   - 身份证号
3. **点击 "Save Changes"**
4. **系统执行：**
   ```sql
   UPDATE users
   SET 
     name = '新姓名',
     phone = '新电话',
     birthday = '新生日',
     address = '新地址',
     id_card = '新身份证'
   WHERE auth_id = '用户的auth_id'
   ```

### 修改密码：
1. **点击 "Change Password"**
2. **输入新密码**
3. **确认密码**
4. **保存**

---

## 🔐 安全保证

### 用户不能修改的关键字段：
```javascript
// 在 saveProfile 函数中，只更新这些字段
.update({
  name: editForm.value.name,
  phone: editForm.value.phone,
  birthday: birthdayISO,
  address: editForm.value.address,
  id_card: editForm.value.id_card
})
// ✅ 不包含积分、会员等级、角色等敏感字段
```

**即使用户通过浏览器开发者工具修改代码，数据库也会拒绝：**
- RLS 策略只允许修改自己的数据
- UPDATE 语句不包含敏感字段

---

## 💡 建议

### 如果你想进一步限制：

**完全禁止用户修改任何信息：**
```sql
-- 删除用户的 UPDATE 权限
DROP POLICY IF EXISTS "update_own" ON users;
DROP POLICY IF EXISTS "allow_own_update" ON users;
```

**只允许查看，所有修改通过管理员：**
```sql
-- 只保留 SELECT 权限
-- 用户想修改资料需要联系管理员
```

---

## ✅ 当前配置（合理平衡）

- ✅ 用户可以更新基本联系信息（便利）
- ❌ 用户不能修改积分、会员等级（安全）
- ✅ 所有财务和游戏数据由系统/管理员控制

---

**这个配置是安全且合理的！** 🔐

用户只能修改自己的联系方式和基本信息，所有重要数据都受保护。

**刷新 Profile 页面，应该正常加载了！** ✅

