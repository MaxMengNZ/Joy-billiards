# 🎱 Battle System - 完整指南（打印版）

**系统版本**: Battle Ranking System v1.2 (修正版 + Streak System)  
**打印日期**: 2026-02-04  
**文档版本**: Complete Guide v1.0

---

## 📊 Elo 计算公式

### 基础公式
```
期望得分 = 1 / (1 + 10^((对手Elo - 我的Elo) / 400))
Elo变化 = K × (实际得分 - 期望得分)
```

### 参数设置
- **K-factor (K值)**: 32
- **实际得分**: 胜利 = 1, 失败 = 0
- **初始 Elo**: 1000

**注意**: 表格中的 Elo 变化值为四舍五入后的近似值

---

## 📈 Elo 变化对照表

### 相同 Elo 对战

| 我的Elo | 对手Elo | Elo差距 | 我获胜 | 我失败 | 说明 |
|---------|---------|---------|--------|--------|------|
| 1000 | 1000 | 0 | +16 | -16 | 相同水平，正常变化 |
| 1200 | 1200 | 0 | +16 | -16 | 相同水平，正常变化 |
| 1500 | 1500 | 0 | +16 | -16 | 相同水平，正常变化 |

### 高 Elo 击败低 Elo

| 我的Elo | 对手Elo | Elo差距 | 我获胜 | 我失败 | 说明 |
|---------|---------|---------|--------|--------|------|
| 1100 | 1000 | +100 | +12 | -12 | 略高，小幅变化 |
| 1200 | 1000 | +200 | +8 | -8 | 明显高，变化较小 |
| 1300 | 1000 | +300 | +5 | -5 | 差距较大，变化很小 |
| 1400 | 1000 | +400 | +3 | -3 | 差距很大，几乎不涨分 |
| 1500 | 1000 | +500 | +2 | -2 | 巨大差距，几乎不涨分 |

### 低 Elo 击败高 Elo（爆冷）

| 我的Elo | 对手Elo | Elo差距 | 我获胜 | 我失败 | 说明 |
|---------|---------|---------|--------|--------|------|
| 1000 | 1100 | -100 | +20 | -20 | 略低，奖励更多 |
| 1000 | 1200 | -200 | +24 | -24 | 明显低，大幅奖励 |
| 1000 | 1300 | -300 | +27 | -27 | 差距较大，巨大奖励 |
| 1000 | 1400 | -400 | +29 | -29 | 差距很大，接近最大奖励 |
| 1000 | 1500 | -500 | +30 | -30 | 巨大差距，最大奖励 |

### 中等差距对战

| 我的Elo | 对手Elo | Elo差距 | 我获胜 | 我失败 | 说明 |
|---------|---------|---------|--------|--------|------|
| 1050 | 1000 | +50 | +14 | -14 | 略高 |
| 1000 | 1050 | -50 | +18 | -18 | 略低 |
| 1150 | 1000 | +150 | +10 | -10 | 明显高 |
| 1000 | 1150 | -150 | +22 | -22 | 明显低 |

---

## 🎯 Elo 变化范围总结

| 情况 | Elo变化范围 | 说明 |
|------|-------------|------|
| 相同水平 | ±16 | 标准变化 |
| 略高/略低 (±50-100) | +12~+14 / +18~+20 | 小幅变化 |
| 明显高/低 (±150-200) | +8~+10 / +22~+24 | 中等变化 |
| 差距很大 (±300-400) | +3~+5 / +27~+29 | 大幅变化 |
| 巨大差距 (±500+) | +1~+2 / +30~+32 | 极端变化 |

**最小变化**: 约 1-2 Elo（巨大差距时高 Elo 获胜）  
**最大变化**: 约 30-32 Elo（低 Elo 击败高 Elo）  
**平均变化**: 约 16 Elo（相同水平时）

**注意**: 表格中的数值为四舍五入后的近似值

---

## 🛡️ 段位保护机制（地板保护）

### 受保护的段位
- ✅ **Bronze III, II, I** (1000-1300)
- ✅ **Silver III, II, I** (1300-1600)
- ✅ **Gold IV** (1600-1700)

### 保护规则（地板保护）
- 失败时 **Elo 不会低于该段位的最低值（elo_min）**
- 例如：Bronze III (1000-1100)，失败后 Elo 不会低于 1000
- **段位不会因为失败而降级**（Elo 被保护在段位下限）
- **星数会随 Elo 变化而变化**（如果 Elo 下降但被保护，星数仍可能下降）

### 无保护的段位
- ❌ **Gold III, II, I** (1700-2000)
- ❌ **Platinum** 所有段位 (2000-2400)
- ❌ **Diamond** 所有段位 (2400-2800)
- ❌ **Master** 所有段位 (2800-3200)
- ❌ **Grand Master+** 所有段位 (3200+)

---

## 📊 段位与 Elo 对应表（修正版 - 无重叠）

| 段位 | Elo 范围 | 每段位Elo | 约需场次 | 保护 |
|------|----------|-----------|----------|------|
| **Bronze III** | 1000-1100 | 100 | 6-7场 | ✅ |
| **Bronze II** | 1100-1200 | 100 | 6-7场 | ✅ |
| **Bronze I** | 1200-1300 | 100 | 6-7场 | ✅ |
| **Silver III** | 1300-1400 | 100 | 6-7场 | ✅ |
| **Silver II** | 1400-1500 | 100 | 6-7场 | ✅ |
| **Silver I** | 1500-1600 | 100 | 6-7场 | ✅ |
| **Gold IV** | 1600-1700 | 100 | 6-7场 | ✅ |
| **Gold III** | 1700-1800 | 100 | 6-7场 | ❌ |
| **Gold II** | 1800-1900 | 100 | 6-7场 | ❌ |
| **Gold I** | 1900-2000 | 100 | 6-7场 | ❌ |
| **Platinum IV** | 2000-2100 | 100 | 6-8场 | ❌ |
| **Platinum III** | 2100-2200 | 100 | 6-8场 | ❌ |
| **Platinum II** | 2200-2300 | 100 | 6-8场 | ❌ |
| **Platinum I** | 2300-2400 | 100 | 6-8场 | ❌ |
| **Diamond V** | 2400-2480 | 80 | 5-6场 | ❌ |
| **Diamond IV** | 2480-2560 | 80 | 5-6场 | ❌ |
| **Diamond III** | 2560-2640 | 80 | 5-6场 | ❌ |
| **Diamond II** | 2640-2720 | 80 | 5-6场 | ❌ |
| **Diamond I** | 2720-2800 | 80 | 5-6场 | ❌ |
| **Master V** | 2800-2880 | 80 | 5-6场 | ❌ |
| **Master IV** | 2880-2960 | 80 | 5-6场 | ❌ |
| **Master III** | 2960-3040 | 80 | 5-6场 | ❌ |
| **Master II** | 3040-3120 | 80 | 5-6场 | ❌ |
| **Master I** | 3120-3200 | 80 | 5-6场 | ❌ |
| **Grand Master** | 3200-3400 | 200 | 12-13场 | ❌ |
| **The King** | 3400-3600 | 200 | 12-13场 | ❌ |
| **Legend** | 3600-3800 | 200 | 12-13场 | ❌ |
| **Hall of Fame** | 3800+ | - | - | ❌ |

### 段位宽度说明
- **Bronze, Silver, Gold, Platinum**: 每段位 100 Elo
- **Diamond, Master**: 每段位 80 Elo
- **Grand Master+**: 每段位 200 Elo

### 约需场次说明
- **100 Elo 宽度**: 约 6-7 场（按平均 ±16 Elo/场计算）
- **80 Elo 宽度**: 约 5-6 场（按平均 ±16 Elo/场计算）
- **200 Elo 宽度**: 约 12-13 场（按平均 ±16 Elo/场计算）

---

## 🎮 匹配赛 vs 挑战赛

### 匹配赛（Matchmaking）
**条件**: Elo 差距 ≤ 200 或 段位差 ≤ 2 个小段位

**规则**:
- ✅ 胜利: +1星（通过 Elo 增加实现）
- ❌ 失败: -1星（通过 Elo 减少实现）
- 🛡️ **保护机制**: Gold IV 及以下失败不降段（Elo 地板保护）

**示例**:
- Bronze III vs Bronze II → 匹配赛（段位差 1）
- Gold I vs Platinum IV → 匹配赛（Elo 差 100，段位差 2）
- Bronze III vs Silver I → 挑战赛（段位差 3）

### 挑战赛（Challenge）
**条件**: Elo 差距 > 200 且 段位差 > 2 个小段位

**规则**:
- 低段位击败高段位: +段位差星（通过 Elo 大幅增加实现）
- 高段位击败低段位: -段位差星（通过 Elo 大幅减少实现）

**示例**:
- Bronze III vs Gold I（差3个小段位）
  - Bronze 胜: +3星（通过 Elo +32 实现）
  - Gold 败: -3星（通过 Elo -32 实现）

---

## 🔥 Battle Streak System（连胜系统）

### 适用范围
- ✅ **匹配赛 + 挑战赛全部计入**
- ✅ **奖励策略 A**：每赛季每个阈值只领取一次
- ❌ **不影响 Elo、不影响段位**

---

### 一、Streak 定义（唯一口径）

#### 1️⃣ 连胜（Win Streak）
- **定义**：Battle 模式中连续获胜的场次
- **计数规则**：
  - 胜利 → `current_win_streak +1`
  - 失败 → `current_win_streak = 0`
  - 作废 / 未完成 → 不计入
- **适用模式**：
  - ✅ 匹配赛（Matchmaking）
  - ✅ 挑战赛（Challenge）

#### 2️⃣ 赛季最高连胜（Season Best Streak）
- **定义**：当前赛季内，玩家达到过的最高连续胜场
- **规则**：
  - `season_best_win_streak = max(历史值, current_win_streak)`
- **用途**：
  - 🏆 赛季连胜排行榜
  - 🎖️ 赛季荣誉展示

---

### 二、展示规则（强游戏感，不碰数值）

#### UI 等级标签（仅展示）

| 连胜数 | 展示标签 |
|--------|----------|
| 0–2 | Normal |
| 3–4 | 🔥 Hot Streak |
| 5–6 | 🔥🔥 On Fire |
| 7–9 | 🔥🔥🔥 Dominating |
| 10+ | 👑 Legendary |

#### 展示位置建议
- **个人资料卡**：🔥 Win Streak x5
- **对战房间**：昵称右侧火焰图标
- **排行榜**：显示 Season Best xN

---

### 三、轻奖励规则（策略 A · 最稳）

#### 🎁 奖励原则
- ✅ 只奖励非 Elo 内容（Tokens / Credits / Pass XP）
- ✅ 每赛季每个阈值只领一次
- ❌ 不随连胜继续叠加
- ❌ 不和 Elo、段位挂钩

#### 🎯 奖励阈值（推荐）

| 达到连胜 | 奖励 | 领取规则 |
|----------|------|----------|
| 3 连胜 | +5 Battle Tokens | 赛季内一次 |
| 5 连胜 | +10 Battle Tokens | 赛季内一次 |
| 7 连胜 | +15 Battle Tokens + 24h 称号 | 赛季内一次 |
| 10 连胜 | +25 Battle Tokens + 公告 | 赛季内一次 |

**超过 10 连胜**：
- 继续展示 streak
- 不再发新奖励（防刷、稳平衡）

---

### 四、防刷规则（必须有，已定）

#### 1️⃣ 重复对手限制（强烈推荐）
- **同一对手 24 小时内**
- **只允许 1 场胜利计入 streak & 奖励**
- 超出仍可比赛，但：
  - ❌ 不增加 streak
  - ❌ 不计入赛季连胜榜
  - （是否结算 Elo：保持结算）

#### 2️⃣ 有效对局条件
一场比赛要计入 streak，必须：
- 状态 = `completed`
- 达到最低有效局数 / 分数
- （防止秒投、刷局）

#### 3️⃣ Elo 差距限制（推荐）
- **若双方 Elo 差 > 400**
- 胜负正常记录
- ❌ 不计入 streak / 不发奖励
- （有效防止高段位刷小号）

---

## 📝 快速参考

### Elo 变化速查表

| Elo差距 | 高Elo胜 | 低Elo胜 |
|---------|---------|---------|
| 0 | +16 | +16 |
| ±50 | +14 / +18 | +18 / +14 |
| ±100 | +12 / +20 | +20 / +12 |
| ±150 | +10 / +22 | +22 / +10 |
| ±200 | +8 / +24 | +24 / +8 |
| ±300 | +5 / +27 | +27 / +5 |
| ±400 | +3 / +29 | +29 / +3 |
| ±500 | +2 / +30 | +30 / +2 |

**注意**: 数值为四舍五入后的近似值

### 升级所需场次

| 升级类型 | 约需场次 | 说明 |
|----------|----------|------|
| 小段位（III→II, II→I，100 Elo） | 6-7场 | 每个小段位 |
| 小段位（V→IV→III→II→I，80 Elo） | 5-6场 | Diamond/Master |
| 大段位（Bronze→Silver） | 18-21场 | 3个小段位 |
| Bronze III → Silver I | 30-35场 | 完整升级路径 |

---

## 🔢 计算公式详解

### 期望得分计算
```
期望得分 = 1 / (1 + 10^((对手Elo - 我的Elo) / 400))
```

### Elo变化计算
```
Elo变化 = K × (实际得分 - 期望得分)
其中 K = 32
```

### 实际示例计算

**示例 1: 1000 vs 1000**
- 期望得分 = 1 / (1 + 10^((1000-1000)/400)) = 1 / (1 + 10^0) = 1 / 2 = 0.5
- 我获胜: Elo变化 = 32 × (1 - 0.5) = 32 × 0.5 = +16
- 我失败: Elo变化 = 32 × (0 - 0.5) = 32 × (-0.5) = -16

**示例 2: 1200 vs 1000**
- 期望得分 = 1 / (1 + 10^((1000-1200)/400)) = 1 / (1 + 10^(-0.5)) ≈ 0.76
- 我获胜 (1200): Elo变化 = 32 × (1 - 0.76) = 32 × 0.24 ≈ +8
- 我失败 (1000): Elo变化 = 32 × (0 - 0.24) = 32 × (-0.24) ≈ -8

**示例 3: 1000 vs 1200**
- 期望得分 = 1 / (1 + 10^((1200-1000)/400)) = 1 / (1 + 10^0.5) ≈ 0.24
- 我获胜 (1000): Elo变化 = 32 × (1 - 0.24) = 32 × 0.76 ≈ +24
- 我失败 (1200): Elo变化 = 32 × (0 - 0.76) = 32 × (-0.76) ≈ -24

---

## ⚠️ 重要说明

1. **Elo 是基础**: 所有段位和星数都基于 Elo 计算
2. **自动更新**: 段位和星数通过触发器自动更新，无需手动操作
3. **保护机制**: 低段位有地板保护（Elo 不低于段位下限），高段位需要谨慎
4. **匹配类型**: 根据 Elo 差距和段位差自动判断是匹配赛还是挑战赛
5. **公平性**: 击败高段位获得更多 Elo，击败低段位获得较少 Elo
6. **段位无重叠**: 所有段位区间使用左闭右开 `[elo_min, elo_max)`，确保每个 Elo 值只属于一个段位
7. **连胜系统**: 独立于 Elo 系统，不影响段位和评分
8. **奖励系统**: 自动发放，每赛季每个阈值只能领取一次

---

## 📋 段位序列（完整）

```
Bronze (1000-1300) → Silver (1300-1600) → Gold (1600-2000) →
Platinum (2000-2400) → Diamond (2400-2800) → Master (2800-3200) →
Grand Master (3200-3400) → The King (3400-3600) → Legend (3600-3800) →
Hall of Fame (3800+)
```

---

## 🎯 奖励系统总结

### Battle Tokens 获取方式
- 3连胜：+5 Tokens
- 5连胜：+10 Tokens
- 7连胜：+15 Tokens + 24h 称号
- 10连胜：+25 Tokens + 首页公告

### 称号系统
- **7连胜称号**: "🔥🔥🔥 7-Win Streak Champion"
- **持续时间**: 24小时
- **显示位置**: 个人资料、对战房间

### 公告系统
- **10连胜公告**: 首页展示7天
- **内容**: "[玩家名] achieved a legendary 10-win streak!"
- **状态**: 自动置顶（Featured）

---

**文档结束**
