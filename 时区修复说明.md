# 🕐 比赛时间时区修复

**问题：** 选择11月2日下午2:30，保存后显示11月3日凌晨3:30  
**状态：** ✅ 已修复

---

## 🐛 问题原因

### 之前的代码：
```javascript
// 编辑时转换（错误）
start_date: new Date(tournament.start_date).toISOString().slice(0, 16)

// 这会导致：
// 1. UTC时间 → 本地浏览器时区 → 截取成字符串
// 2. 用户看到的时间是偏移后的
// 3. 保存时又当作本地时间处理
// 结果：时间被双重转换，出现13小时偏移
```

### 问题流程：
1. **数据库存储：** `2025-11-02T14:30:00+00:00` (UTC)
2. **toISOString()转换：** `2025-11-03T03:30:00Z` (本地浏览器时区)
3. **用户看到：** 2025-11-03 03:30（错误！）
4. **保存回去：** 又按本地时间处理 → 再次偏移

---

## ✅ 修复方案

### 新增两个工具函数：

#### 1. `toNZDateTimeLocalValue(date)` - 数据库→表单
将UTC时间转换为新西兰时间的表单值

```javascript
// 用途：编辑比赛时，显示正确的新西兰时间
start_date: toNZDateTimeLocalValue(tournament.start_date)

// 示例：
输入：'2025-11-02T01:30:00.000Z' (UTC)
输出：'2025-11-02T14:30' (新西兰时间，NZDT=UTC+13)
```

#### 2. `fromNZDateTimeLocalValue(value)` - 表单→数据库
将新西兰时间转换为UTC存储

```javascript
// 用途：保存比赛时，正确转换为UTC
start_date: fromNZDateTimeLocalValue(tournamentForm.value.start_date)

// 示例：
输入：'2025-11-02T14:30' (用户选择的新西兰时间)
输出：'2025-11-02T01:30:00.000Z' (UTC存储)
```

---

## 📝 修改的文件

### 1. `src/utils/timezone.js`
新增两个函数处理表单和数据库之间的转换

### 2. `src/views/TournamentsPage.vue`

**导入时区工具：**
```javascript
import { 
  formatNZDate, 
  toNZDateTimeLocalValue,      // 新增
  fromNZDateTimeLocalValue      // 新增
} from '../utils/timezone'
```

**编辑比赛时（显示）：**
```javascript
const editTournament = (tournament) => {
  tournamentForm.value = {
    // 使用新西兰时区转换，避免时区偏移
    start_date: toNZDateTimeLocalValue(tournament.start_date),
    end_date: toNZDateTimeLocalValue(tournament.end_date),
    // ... 其他字段
  }
}
```

**保存比赛时（存储）：**
```javascript
const saveTournament = async () => {
  const data = {
    // 将新西兰时区的输入转换为UTC存储
    start_date: fromNZDateTimeLocalValue(tournamentForm.value.start_date),
    end_date: fromNZDateTimeLocalValue(tournamentForm.value.end_date),
    // ... 其他字段
  }
}
```

---

## 🧪 测试验证

### 测试步骤：

1. **刷新浏览器** 确保加载新代码

2. **编辑学生比赛：**
   - 点击"Edit"按钮
   - 查看开始时间字段
   - 应该显示：`2025-11-02T14:30`（11月2日下午2:30）

3. **修改时间：**
   - 选择：`2025-11-02T14:30`
   - 点击"Update"保存

4. **查看预览：**
   - 外面的卡片应该显示：`02/11/2025, 14:30`
   - 不应该显示：`03/11/2025, 03:30`

---

## 🔍 时区转换原理

### 新西兰时区：
- **夏令时(NZDT):** UTC+13 (9月末 - 4月初)
- **标准时间(NZST):** UTC+12 (4月 - 9月)
- **当前（11月）：** 使用NZDT (UTC+13)

### 转换示例：

| 用户选择（NZ时间） | 存储（UTC） | 时差 |
|-------------------|-------------|------|
| 2025-11-02 14:30 | 2025-11-02 01:30 | -13小时 |
| 2025-11-07 19:00 | 2025-11-07 06:00 | -13小时 |
| 2025-06-15 10:00 | 2025-06-14 22:00 | -12小时 |

---

## ⚠️ 重要提醒

### 对于管理员：
1. ✅ **总是按新西兰时间选择**
   - 下午2:30 → 选择 14:30
   - 晚上7:00 → 选择 19:00

2. ✅ **保存后检查预览**
   - 确认外面显示的时间和你选择的一致

3. ✅ **所有玩家看到相同时间**
   - 不管他们在哪里访问
   - 都会看到新西兰本地时间

### 对于开发：
- ❌ 不要直接使用 `new Date().toISOString()`
- ❌ 不要直接使用 `toLocaleDateString()`
- ✅ 使用 `timezone.js` 提供的工具函数
- ✅ 表单输入/输出都用专门的转换函数

---

## 📊 当前状态

### ✅ 已修复：
- [x] 比赛编辑时间显示正确
- [x] 保存后时间不会偏移
- [x] 预览框显示正确时间
- [x] 所有时间统一使用新西兰时区

### 📝 需要注意：
- 现有比赛可能需要重新编辑保存一次（如果之前存储错误）
- 建议检查所有比赛的开始时间是否正确

---

## 🎯 快速修复已有比赛

如果之前的比赛时间不对，可以：

1. **方法1：重新编辑（推荐）**
   - 点击比赛的"Edit"
   - 重新选择正确的时间
   - 点击"Update"

2. **方法2：SQL直接修复**
   ```sql
   -- 查看当前存储的时间
   SELECT id, name, 
          start_date,
          start_date AT TIME ZONE 'Pacific/Auckland' as nz_time
   FROM tournaments;
   
   -- 如果需要调整（例如减去13小时偏移）
   UPDATE tournaments
   SET start_date = start_date - INTERVAL '13 hours'
   WHERE id = 'tournament_id';
   ```

---

## ✅ 修复完成！

现在：
- ✅ 选择 11月2日 14:30 → 显示 11月2日 14:30
- ✅ 选择 11月7日 19:00 → 显示 11月7日 19:00
- ✅ 所有时间都是新西兰本地时间

**刷新浏览器，试试编辑比赛吧！** 🎉

