# 📊 添加排名积分指南

**状态：** ✅ 所有排名积分已清除，可以重新添加

---

## ✅ 清除完成

- **清除用户数：** 109 个用户
- **排名积分：** 全部归零
- **段位等级：** 重置为 Beginner
- **积分历史：** 已清空

**现在可以重新输入正确的段位积分了！**

---

## 📝 如何添加排名积分

### 方法 1：使用 SQL 函数（推荐）

打开 [Supabase SQL Editor](https://app.supabase.com/project/qnwtqgdbgyqwpsdqvxfl/sql/new)

#### 单个用户添加积分：

```sql
-- 1. 先查询用户 ID
SELECT id, name, email FROM users WHERE name LIKE '%用户名%';

-- 2. 添加排名积分
SELECT admin_add_ranking_points(
  '用户的UUID',           -- user_id
  20,                      -- 积分数量
  'Initial ranking points', -- 原因
  '你的管理员UUID'         -- admin_id (可选)
);
```

#### 批量添加积分示例：

```sql
-- 假设你有一个选手列表和对应的积分

-- 1. 查看所有用户和ID
SELECT id, name, email, ranking_points 
FROM users 
WHERE is_active = true
ORDER BY name;

-- 2. 批量添加（示例）
SELECT admin_add_ranking_points(
  (SELECT id FROM users WHERE name = '张三'),
  150,
  'November 2025 ranking',
  (SELECT id FROM users WHERE role = 'admin' LIMIT 1)
);

SELECT admin_add_ranking_points(
  (SELECT id FROM users WHERE name = '李四'),
  120,
  'November 2025 ranking',
  (SELECT id FROM users WHERE role = 'admin' LIMIT 1)
);

-- ... 重复每个选手
```

---

### 方法 2：直接更新（快速但不记录历史）

```sql
-- 直接更新用户的 ranking_points
UPDATE users 
SET 
  ranking_points = 150,  -- 积分
  ranking_level = 'elite',  -- 对应的段位等级
  updated_at = now()
WHERE name = '选手姓名';

-- 批量更新示例
UPDATE users SET ranking_points = 200, ranking_level = 'master' WHERE name = '张三';
UPDATE users SET ranking_points = 180, ranking_level = 'elite' WHERE name = '李四';
UPDATE users SET ranking_points = 150, ranking_level = 'elite' WHERE name = '王五';
```

---

## 🎯 段位等级对照表

根据积分自动分配段位：

| 段位等级 | 英文名 | 积分范围 | 代码 |
|---------|--------|----------|------|
| 👑 Hall of Fame | 名人堂 | 550+ | `hall_of_fame` |
| 💎 Pro Level | 职业级 | 450-549 | `pro_level` |
| 🌟 Grand Master | 特级大师 | 350-449 | `grand_master` |
| ⭐ Master | 大师 | 250-349 | `master` |
| 🔷 Elite | 精英 | 150-249 | `elite` |
| 🔶 Expert | 专家 | 80-149 | `expert` |
| 🔺 Advance | 高级 | 40-79 | `advance` |
| 🔸 Intermediate | 中级 | 15-39 | `intermediate` |
| ⚪ Beginner | 初级 | 0-14 | `beginner` |

---

## 📋 模板：批量添加积分

### 步骤 1：准备数据

创建一个表格：

| 选手姓名 | 当前积分 | 段位等级 |
|---------|---------|----------|
| 张三 | 250 | master |
| 李四 | 180 | elite |
| 王五 | 150 | elite |
| 赵六 | 120 | expert |

### 步骤 2：生成 SQL 语句

```sql
-- 批量更新模板
DO $$
DECLARE
  v_admin_id UUID;
BEGIN
  -- 获取管理员 ID（你自己）
  SELECT id INTO v_admin_id FROM users WHERE role = 'admin' LIMIT 1;
  
  -- 批量添加积分
  PERFORM admin_add_ranking_points(
    (SELECT id FROM users WHERE name = '张三'),
    250,
    'November 2025 Ranking',
    v_admin_id
  );
  
  PERFORM admin_add_ranking_points(
    (SELECT id FROM users WHERE name = '李四'),
    180,
    'November 2025 Ranking',
    v_admin_id
  );
  
  PERFORM admin_add_ranking_points(
    (SELECT id FROM users WHERE name = '王五'),
    150,
    'November 2025 Ranking',
    v_admin_id
  );
  
  -- ... 继续添加其他选手
  
END $$;
```

### 步骤 3：更新段位等级

```sql
-- 根据积分自动更新段位
UPDATE users 
SET ranking_level = CASE
  WHEN ranking_points >= 550 THEN 'hall_of_fame'
  WHEN ranking_points >= 450 THEN 'pro_level'
  WHEN ranking_points >= 350 THEN 'grand_master'
  WHEN ranking_points >= 250 THEN 'master'
  WHEN ranking_points >= 150 THEN 'elite'
  WHEN ranking_points >= 80 THEN 'expert'
  WHEN ranking_points >= 40 THEN 'advance'
  WHEN ranking_points >= 15 THEN 'intermediate'
  ELSE 'beginner'
END
WHERE ranking_points > 0;
```

---

## 🔍 验证积分

### 查看排行榜前10名：

```sql
SELECT 
  name,
  ranking_points,
  ranking_level,
  wins,
  losses,
  CASE 
    WHEN wins + losses > 0 
    THEN ROUND((wins::NUMERIC / (wins + losses)) * 100, 1)
    ELSE 0
  END as win_rate
FROM users
WHERE is_active = true
ORDER BY ranking_points DESC
LIMIT 10;
```

### 查看所有有积分的用户：

```sql
SELECT 
  name,
  email,
  ranking_points,
  ranking_level,
  membership_level
FROM users
WHERE ranking_points > 0
ORDER BY ranking_points DESC;
```

---

## 💡 快速操作指南

### 1️⃣ 查找用户 ID

```sql
-- 按姓名查找
SELECT id, name, email FROM users WHERE name = '张三';

-- 模糊查找
SELECT id, name, email FROM users WHERE name LIKE '%张%';

-- 查看所有活跃用户
SELECT id, name, email FROM users WHERE is_active = true ORDER BY name;
```

### 2️⃣ 添加积分

```sql
-- 替换这些值
SELECT admin_add_ranking_points(
  'USER_ID_HERE',     -- 第1步查到的用户ID
  100,                -- 要添加的积分
  'Reason here',      -- 原因说明
  'YOUR_ADMIN_ID'     -- 你的管理员ID（可选）
);
```

### 3️⃣ 更新段位

```sql
-- 手动更新单个用户的段位
UPDATE users 
SET ranking_level = 'elite'
WHERE id = 'USER_ID_HERE';

-- 或自动根据积分更新所有用户
UPDATE users 
SET ranking_level = CASE
  WHEN ranking_points >= 550 THEN 'hall_of_fame'
  WHEN ranking_points >= 450 THEN 'pro_level'
  WHEN ranking_points >= 350 THEN 'grand_master'
  WHEN ranking_points >= 250 THEN 'master'
  WHEN ranking_points >= 150 THEN 'elite'
  WHEN ranking_points >= 80 THEN 'expert'
  WHEN ranking_points >= 40 THEN 'advance'
  WHEN ranking_points >= 15 THEN 'intermediate'
  ELSE 'beginner'
END
WHERE ranking_points > 0;
```

---

## ⚠️ 重要提醒

### ✅ 记住：

1. **Ranking Points = 段位积分**
   - 用于排行榜排名
   - 决定段位等级
   - 只记录比赛表现

2. **Loyalty Points = 消费积分**
   - 用于会员福利
   - 不影响排名
   - 记录消费金额

3. **不要混淆两种积分！**

### 📝 建议流程：

1. **准备数据表格**
   - 列出所有选手
   - 确定每人的积分
   - 确定对应的段位

2. **使用 SQL 批量添加**
   - 一次性添加所有积分
   - 自动更新段位等级

3. **验证结果**
   - 查看排行榜
   - 确认积分和段位正确

4. **刷新前端**
   - 打开排行榜页面
   - 确认显示正确

---

## 🎯 示例：完整流程

### 假设你要添加5个选手的积分：

```sql
-- 第1步：查看用户列表（找到ID）
SELECT id, name FROM users 
WHERE name IN ('张三', '李四', '王五', '赵六', '孙七')
ORDER BY name;

-- 第2步：批量添加积分（假设你的admin_id是 'xxx-xxx-xxx'）
SELECT admin_add_ranking_points(
  (SELECT id FROM users WHERE name = '张三'), 300, 'November ranking', 'your-admin-id'
);
SELECT admin_add_ranking_points(
  (SELECT id FROM users WHERE name = '李四'), 250, 'November ranking', 'your-admin-id'
);
SELECT admin_add_ranking_points(
  (SELECT id FROM users WHERE name = '王五'), 200, 'November ranking', 'your-admin-id'
);
SELECT admin_add_ranking_points(
  (SELECT id FROM users WHERE name = '赵六'), 150, 'November ranking', 'your-admin-id'
);
SELECT admin_add_ranking_points(
  (SELECT id FROM users WHERE name = '孙七'), 100, 'November ranking', 'your-admin-id'
);

-- 第3步：自动更新段位等级
UPDATE users 
SET ranking_level = CASE
  WHEN ranking_points >= 550 THEN 'hall_of_fame'
  WHEN ranking_points >= 450 THEN 'pro_level'
  WHEN ranking_points >= 350 THEN 'grand_master'
  WHEN ranking_points >= 250 THEN 'master'
  WHEN ranking_points >= 150 THEN 'elite'
  WHEN ranking_points >= 80 THEN 'expert'
  WHEN ranking_points >= 40 THEN 'advance'
  WHEN ranking_points >= 15 THEN 'intermediate'
  ELSE 'beginner'
END
WHERE ranking_points > 0;

-- 第4步：验证结果
SELECT name, ranking_points, ranking_level 
FROM users 
WHERE ranking_points > 0 
ORDER BY ranking_points DESC;
```

---

## 🚀 现在开始吧！

1. 打开 [Supabase SQL Editor](https://app.supabase.com/project/qnwtqgdbgyqwpsdqvxfl/sql/new)
2. 准备你的选手积分数据
3. 使用上面的模板添加积分
4. 刷新排行榜页面查看结果

**祝你添加顺利！** 🎉

---

**提示：** 如果需要我帮你生成批量添加的 SQL 语句，把选手名单和积分发给我，我可以直接生成！

