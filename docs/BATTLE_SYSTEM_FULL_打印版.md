# Joy Billiards — 对战系统完整文档（打印版）

**系统名称**: Battle 对战系统（球房房间 + Elo 段位 + 连胜）  
**文档版本**: 1.1（统一 Elo，无 Pro/Student 组别）  
**打印日期**: 请填写 _______________

---

## 目录

1. [系统概述](#1-系统概述)
2. [数据库与表结构](#2-数据库与表结构)
3. [Elo 计算与段位系统](#3-elo-计算与段位系统)
4. [段位保护与匹配类型](#4-段位保护与匹配类型)
5. [连胜系统（Streak）](#5-连胜系统streak)
6. [房间流程与权限](#6-房间流程与权限)
7. [前端与路由](#7-前端与路由)
8. [本地测试与检查清单](#8-本地测试与检查清单)
9. [快速参考表](#9-快速参考表)

---

## 1. 系统概述

- **定位**：与周赛排行榜完全独立的 Battle 对战系统，用于球房内实时对战与排名。**全新功能，不区分 Pro/Student 组别。**
- **统一 Elo**：全站**一套** Battle Elo 与排名（`battle_elo_rating`、`battle_tier`、`battle_stars`），**无组别**，单一全球排行榜。
- **核心能力**：
  - 创建球局（房间）、加入房间、双方确认准备、开始比赛、记录得分、完成比赛。
  - 比赛结束后自动更新 Elo、段位、星数、胜败场、连胜、全球排名。
- **不影响**：周赛积分（ranking_points）与 Heyball 排行榜；Battle 仅使用 Battle 相关字段。

---

## 2. 数据库与表结构

### 2.1 主要表

| 表名 | 说明 |
|------|------|
| `battle_rooms` | 球局房间：创建者、玩家1/2、抢局数、状态、准备/开始/完成时间、胜者与比分、Elo 前后值等（division 字段可选，兼容旧数据） |
| `battle_match_scores` | 比赛进行中的得分记录：房间 ID、记录者、双方当前得分、局数、备注等 |

### 2.2 users 表 Battle 相关字段（统一，无组别）

| 字段 | 说明 |
|------|------|
| `battle_elo_rating` | 统一 Battle Elo（默认 1000） |
| `battle_tier` | 当前段位（如 bronze_iii, gold_i） |
| `battle_stars` | 当前段位内星数（0–3 等） |
| `battle_position` | 全球排名 |
| `battle_wins` | 总胜场 |
| `battle_losses` | 总负场 |
| `battle_streak` | 连胜/连败数 |
| `last_battle_match_at` | 最后一场 Battle 时间 |

### 2.3 房间状态（battle_rooms.status）

- `waiting` — 等待对手入座  
- `ready` — 双方已确认准备  
- `in_progress` — 比赛进行中  
- `completed` — 比赛已完成  
- `cancelled` — 已取消  

### 2.4 核心函数与触发器

- **Elo 计算**：`calculate_elo_change()`（或等价函数）  
- **比赛结束后更新 Elo / 胜败 / 连胜**：`update_elo_after_battle_match()` 或 `update_elo_after_battle_room_complete()`  
- **排名更新**：`update_battle_positions()`  
- **得分记录权限**：`check_score_recording_permission()`（仅房间内玩家或管理员可记分）

---

## 3. Elo 计算与段位系统（当前机制）

以下公式与段位表与当前数据库实现一致（统一 `battle_elo_rating` + 段位保护 + 匹配赛/挑战赛规则）。

### 3.1 基础公式

```
期望得分 = 1 / (1 + 10^((对手Elo - 我的Elo) / 400))
Elo变化 = K × (实际得分 - 期望得分)
```

- **K 值**: 32  
- **实际得分**: 胜 = 1，负 = 0  
- **初始 Elo**: 1000  

### 3.2 段位与 Elo 对应表（无重叠）

| 段位 | Elo 范围 | 每段位 Elo | 约需场次 | 保护 |
|------|----------|------------|----------|------|
| Bronze III | 1000-1100 | 100 | 6-7场 | ✅ |
| Bronze II | 1100-1200 | 100 | 6-7场 | ✅ |
| Bronze I | 1200-1300 | 100 | 6-7场 | ✅ |
| Silver III | 1300-1400 | 100 | 6-7场 | ✅ |
| Silver II | 1400-1500 | 100 | 6-7场 | ✅ |
| Silver I | 1500-1600 | 100 | 6-7场 | ✅ |
| Gold IV | 1600-1700 | 100 | 6-7场 | ✅ |
| Gold III | 1700-1800 | 100 | 6-7场 | ❌ |
| Gold II | 1800-1900 | 100 | 6-7场 | ❌ |
| Gold I | 1900-2000 | 100 | 6-7场 | ❌ |
| Platinum IV～I | 2000-2400 | 100 | 6-8场 | ❌ |
| Diamond V～I | 2400-2800 | 80 | 5-6场 | ❌ |
| Master V～I | 2800-3200 | 80 | 5-6场 | ❌ |
| Grand Master | 3200-3400 | 200 | 12-13场 | ❌ |
| The King | 3400-3600 | 200 | 12-13场 | ❌ |
| Legend | 3600-3800 | 200 | 12-13场 | ❌ |
| Hall of Fame | 3800+ | - | - | ❌ |

### 3.3 Elo 变化对照（示例）

- **相同 Elo（如 1000 vs 1000）**：胜 +16，负 -16  
- **高 Elo 胜（如 1200 vs 1000）**：高 Elo 约 +8，低 Elo 约 -8  
- **低 Elo 胜（如 1000 vs 1200）**：低 Elo 约 +24，高 Elo 约 -24  
- **巨大差距（如 1500 vs 1000）**：高 Elo 胜约 +2，低 Elo 胜约 +30  

### 3.4 速查表

| Elo 差距 | 高 Elo 胜 | 低 Elo 胜 |
|----------|-----------|-----------|
| 0 | +16 | +16 |
| ±100 | +12 / +20 | +20 / +12 |
| ±200 | +8 / +24 | +24 / +8 |
| ±400 | +3 / +29 | +29 / +3 |
| ±500 | +2 / +30 | +30 / +2 |

---

## 4. 段位保护与匹配类型

### 4.1 段位保护（地板保护）

- **受保护**：Bronze III～I、Silver III～I、Gold IV。失败时 **Elo 不低于该段位下限**，**段位不降级**。  
- **无保护**：Gold III 及以上所有段位，失败可正常降段。

### 4.2 匹配赛 vs 挑战赛

- **匹配赛**：Elo 差 ≤ 200 且段位差 ≤ 2 个小段。胜 +1 星（通过 Elo 增加），负 -1 星（通过 Elo 减少），保护段位内不降段。  
- **挑战赛**：Elo 差 > 200 且段位差 > 2 个小段。低段位胜：按段位差加星（Elo 大幅增加）；高段位胜：按段位差减星（Elo 大幅减少）。

---

## 5. 连胜系统（Streak）

- **定义**：Battle 中连续获胜场次；失败则连胜归零。  
- **赛季最高连胜**：当前赛季内达到过的最大连胜，用于排行榜与荣誉展示。  
- **不影响**：Elo、段位、星数仅由胜负与 Elo 公式决定；连胜只做展示与奖励判定。

### 5.1 展示标签（仅 UI）

| 连胜数 | 标签 |
|--------|------|
| 0–2 | Normal |
| 3–4 | 🔥 Hot Streak |
| 5–6 | 🔥🔥 On Fire |
| 7–9 | 🔥🔥🔥 Dominating |
| 10+ | 👑 Legendary |

### 5.2 奖励（每赛季每档仅领一次）

| 达到连胜 | 奖励 |
|----------|------|
| 3 | +5 Battle Tokens |
| 5 | +10 Battle Tokens |
| 7 | +15 Battle Tokens + 24h 称号 |
| 10 | +25 Battle Tokens + 公告 |

### 5.3 防刷规则（建议）

- 同一对手 24 小时内仅 1 场胜利计入 streak/奖励。  
- 对局需为有效完成（如状态 completed、满足最低局数等）。  
- 双方 Elo 差 > 400 时可不计入 streak/奖励（具体以实现为准）。

---

## 6. 房间流程与权限

### 6.1 使用流程

1. **创建球局**：房间名、开始时间（可选）、抢局数（如 4–15）、搜索并选择对手 → 创建房间。  
2. **加入房间**：在「等待中」房间点击加入，等待创建者侧确认。  
3. **确认准备**：双方在房间内各自「确认准备」；双方都确认后状态为 `ready`。  
4. **开始比赛**：任意一方或管理员点击「开始比赛」，状态变为 `in_progress`。  
5. **记录得分**：仅房间内玩家或管理员可录入双方当前得分、局数、备注。  
6. **完成比赛**：选择胜者、录入最终比分并提交；系统自动更新 Elo、段位、排名、胜败场、连胜等。

### 6.2 权限概要

- **创建/加入房间**：登录用户。  
- **确认准备/开始比赛**：房间内玩家；开始比赛可由管理员代操作。  
- **记录得分**：房间内玩家或管理员（由 `check_score_recording_permission` 等校验）。  
- **完成比赛**：房间内玩家或管理员。

---

## 7. 前端与路由

- **路由**：`/battle`（对战主页面）、`/battle/leaderboard` 或等价（Battle 排行榜，统一排名无组别）。  
- **主要页面/组件**：`BattlePage.vue`（房间列表与入口）、`BattleLeaderboardPage.vue`（排行榜）、`BattleRoomCard.vue`、`CreateRoomModal.vue`、`RoomDetailModal.vue`、`BattleProfileModal.vue` 等。  
- **状态**：`battleStore.js`（Pinia），管理房间列表、当前房间、排行榜、挑战等。  
- **导航**：App 导航中「⚔️ Battle」指向对战入口。

---

## 8. 本地测试与检查清单

### 8.1 准备

- 执行 Battle 相关数据库迁移（如 `battle_system.sql`、`battle_rooms_system.sql` 及后续迁移）。  
- 本地运行：`npm run dev`，访问 `http://localhost:3001/battle`。

### 8.2 功能检查清单

- [ ] 可访问 Battle 页面（单一排行榜，无组别切换）  
- [ ] 可创建房间（名称、抢局数、选择对手）  
- [ ] 可加入「等待中」房间  
- [ ] 双方可确认准备，状态变为「准备中」  
- [ ] 可开始比赛，状态变为「进行中」  
- [ ] 仅房间内玩家/管理员可记录得分  
- [ ] 可完成比赛并选择胜者、录入比分  
- [ ] 完成后 Elo、段位、排名、胜败场、连胜自动更新  
- [ ] Battle 排行榜与周赛排行榜互不影响  

### 8.3 常见问题

- **看不到 Battle 页**：确认已登录、路由与导航配置正确。  
- **Elo 不更新**：检查触发器与 `update_battle_positions` 是否执行、数据库日志。  
- **排行榜为空**：新环境无对局时属正常；完成几场 Battle 后应有数据。

---

## 9. 快速参考表

### 段位顺序（由低到高）

```
Bronze (1000-1300) → Silver (1300-1600) → Gold (1600-2000) →
Platinum (2000-2400) → Diamond (2400-2800) → Master (2800-3200) →
Grand Master (3200-3400) → The King (3400-3600) → Legend (3600-3800) →
Hall of Fame (3800+)
```

### 升级约需场次

| 类型 | 约需场次 |
|------|----------|
| 小段位（100 Elo） | 6-7 场 |
| 小段位（80 Elo，Diamond/Master） | 5-6 场 |
| 大段位（如 Bronze→Silver） | 18-21 场 |
| Bronze III → Silver I | 约 30-35 场 |

### 重要说明

1. 段位与星数均基于 Elo，由触发器/函数自动更新。  
2. 低段位有地板保护，高段位无保护。  
3. 匹配赛/挑战赛由 Elo 差与段位差自动判定。  
4. 连胜仅影响展示与奖励，不影响 Elo/段位。  
5. Battle 与周赛数据完全分离。

---

**文档结束 — Joy Billiards Battle 对战系统完整说明**
